# AMBITIA Progress Log
# Append-only learnings for Claude Code iterations

## Project Context
- Platform: Recruitment platform for ESSR (Swiss health school)
- First job: Setter for FSM (Formation Secrétaire Médicale)
- Stack: Astro + Supabase + DaisyUI + GitHub Pages
- Target users: Candidates from Madagascar, Morocco, francophone Africa

## Key Files to Reference
- PLAN-AMBITIA-V3-FINAL.md - Full project plan
- METHODOLOGY-AMBITIA.md - Development guidelines
- SCORECARD-SETTER-ESSR.md - Setter job scorecard with evaluation criteria
- ESSR-FORMATIONS.md - ESSR product knowledge

## Critical Rules
1. RLS (Row Level Security) on EVERY Supabase table
2. Mobile-first design (target audience = mobile users in Africa)
3. Consent modals BEFORE Big Five test and voice recording
4. French is primary language, English secondary
5. Theme colors: primary #2D5BFF, secondary #6C5CE7, accent #00D9A3

---

## Codebase Patterns
- Tailwind CSS v4 + DaisyUI 5: config is done in CSS via `@plugin "daisyui"` and `@plugin "daisyui/theme"` directives, NOT in tailwind.config.mjs
- Font override: use `@theme { --font-sans: "Inter", ... }` in global.css for Tailwind v4
- Global CSS import: each page/layout must `import '../styles/global.css'` in frontmatter
- DaisyUI theme activation: add `data-theme="ambitia"` to `<html>` element
- Astro project uses static output mode by default (good for GitHub Pages)
- BaseLayout.astro: use `<BaseLayout title="..." description="...">` to wrap all pages; includes navbar, footer, SEO
- Import in pages: `import BaseLayout from '../layouts/BaseLayout.astro';`
- Client-side auth: use `createClient()` in `<script>` tags, check `getSession()`, redirect to /login if null
- Dynamic routes: use `getStaticPaths()` with jobs data from `src/data/jobs.ts`
- Supabase client: `import { supabase } from '../lib/supabase'` (server-side) or inline `createClient()` in `<script>` (client-side)
- Migration files: `supabase/migrations/NNN_description.sql` (numbered sequentially)
- RLS test files: `tests/rls/tablename.test.sql`
- Reusable `update_updated_at()` trigger function (defined in 001_create_profiles.sql)

---
# Iteration Logs (append below)

## 2026-02-09 - S1-001
- Initialized Astro project (v5.17) with minimal template
- Installed Tailwind CSS v4.1.18 via `npx astro add tailwind`
- Installed DaisyUI v5.5.18
- Created custom 'ambitia' theme with oklch colors matching: primary #2D5BFF, secondary #6C5CE7, accent #00D9A3, neutral #1A1D29
- Configured Inter font from Google Fonts (preconnect + stylesheet link)
- Set `--font-sans` theme variable for Tailwind v4
- Files changed: package.json, astro.config.mjs, tsconfig.json, src/styles/global.css, src/pages/index.astro
- **Learnings for future iterations:**
  - Astro `create astro` won't initialize in a non-empty directory; use temp dir + copy
  - Tailwind v4 uses `@theme` directives in CSS instead of tailwind.config.mjs
  - DaisyUI 5 uses `@plugin "daisyui/theme"` in CSS for theme definition
  - oklch color space required for DaisyUI 5 theme colors
  - Build warning about `@property` in DaisyUI CSS is benign
---

## 2026-02-09 - S1-002
- Created BaseLayout.astro with responsive navbar, mobile hamburger, footer, SEO meta tags
- Navbar: AMBITIA logo/link, nav links (Accueil, Postes, À propos), Connexion button
- Footer: links to À propos, Postes, Confidentialité, CGU + copyright
- SEO: og:title, og:description, og:type, og:locale, twitter:card meta tags
- Title and description are configurable via Props
- Updated index.astro to use BaseLayout
- Files changed: src/layouts/BaseLayout.astro (new), src/pages/index.astro (updated)
- **Learnings for future iterations:**
  - BaseLayout accepts `title` and `description` props for per-page SEO
  - DaisyUI `navbar` component handles responsive layout well with `navbar-start/center/end`
  - Use `dropdown` component for mobile hamburger menu (works without JS)
  - `flex flex-col` on body + `flex-1` on main ensures footer stays at bottom
  - Import path from pages: `../layouts/BaseLayout.astro`
---

## 2026-02-09 - S1-003
- Created full landing page with hero section, video placeholder, mission statement, and CTA
- Hero: tagline "Trouvez le poste qui vous correspond", video teaser placeholder, CTA "Voir les postes" → /jobs
- Mission section: 3 steps (Postulez → Passez les tests → Décrochez le poste) with numbered cards
- Bottom CTA section with dark background matching hero
- Files changed: src/pages/index.astro (updated)
- **Learnings for future iterations:**
  - DaisyUI `hero` component works well for full-width hero sections
  - Use `bg-neutral text-neutral-content` for dark sections, `bg-base-100` for light
  - `aspect-square` is useful for placeholder containers
  - `opacity-60` / `opacity-80` / `opacity-90` for text hierarchy on dark backgrounds
---

## 2026-02-09 - S1-004
- Created /jobs listing page with country filter, job cards, and empty state
- Created JobCard.astro component (title, country flag, location, salary badge, contract type)
- Created src/data/jobs.ts with mock data for 2 Setter ESSR jobs (MG + MA)
- Client-side country filter with active button state toggle
- Files changed: src/pages/jobs/index.astro (new), src/components/JobCard.astro (new), src/data/jobs.ts (new)
- **Learnings for future iterations:**
  - Static mock data in src/data/ works well until Supabase is connected
  - Job interface defined in jobs.ts can be reused across pages
  - Import paths from pages/jobs/: `../../layouts/BaseLayout.astro`, `../../components/`, `../../data/`
  - Client-side filtering via `<script>` tag works without any framework
---

## 2026-02-09 - S1-005
- Created /jobs/[id].astro dynamic page with getStaticPaths
- Full job detail: description, requirements list, contract info card, salary badge
- CTA "Postuler" button (disabled for now, links to /apply/[id] later)
- Back to jobs link
- Files changed: src/pages/jobs/[id].astro (new)
- **Learnings for future iterations:**
  - Astro static mode requires `getStaticPaths()` for dynamic routes
  - Props passed via getStaticPaths are available as `Astro.props`
  - Build generates /jobs/setter-essr-mg/index.html and /jobs/setter-essr-ma/index.html
---

## 2026-02-09 - S1-006
- Installed @supabase/supabase-js
- Created src/lib/supabase.ts with client using PUBLIC_SUPABASE_URL and PUBLIC_SUPABASE_ANON_KEY
- .env.example already existed with all required variables
- Google OAuth documented as "configured in Supabase dashboard" (manual step)
- Files changed: src/lib/supabase.ts (new), package.json, package-lock.json
- **Learnings for future iterations:**
  - Supabase client uses `import.meta.env.PUBLIC_*` for Astro public env vars
  - Import path: `import { supabase } from '../lib/supabase'`
---

## 2026-02-09 - S1-007
- Created profiles table migration with RLS policies
- Fields: id (FK to auth.users), email, full_name, phone, country, role, created_at, updated_at
- Role CHECK: candidate, recruiter, admin
- RLS policies: users read/update own, admins read all
- Trigger: auto-create profile on auth.users insert
- Trigger: auto-update updated_at
- RLS test file created in tests/rls/profiles.test.sql
- Files changed: supabase/migrations/001_create_profiles.sql (new), tests/rls/profiles.test.sql (new)
---

## 2026-02-09 - S1-008
- Created jobs table migration with multi-country support and RLS
- Fields: id, title, description, requirements (TEXT[]), country, salary_amount, salary_currency, salary_label, contract_type, location, status, test_config (JSONB), created_at
- Status CHECK: draft, open, closed
- RLS: anyone can read open jobs, admins can CRUD all
- Multi-country: same title can exist for different country rows
- RLS test file validates candidate restrictions, admin CRUD, and multi-country support
- Files changed: supabase/migrations/002_create_jobs.sql (new), tests/rls/jobs.test.sql (new)
- **Learnings for future iterations:**
  - Migration files in supabase/migrations/ numbered sequentially
  - RLS test files in tests/rls/ named after the table
  - `update_updated_at()` function is reusable across tables
---

## 2026-02-09 - S1-009
- Created /about page with mission statement, 3-step process, team section, and CTA
- Team section shows François Dupuis (Fondateur) and Laura Escariz (Co-fondatrice) with initials
- CTA links to /jobs
- Files changed: src/pages/about.astro (new)
---

## 2026-02-09 - Sprint 2 Summary (S2-001 to S2-008)
- S2-001: Login/signup pages with Google OAuth + email/password (client-side Supabase)
- S2-002: Candidate dashboard with protected route, applications list, empty state
- S2-003: Profile edit page with country dropdown (16 African countries)
- S2-004: Applications table migration with RLS + test file
- S2-005: Application form (/apply/[id]) with knockout questions + Postuler button enabled on job detail
- S2-006: Storage bucket 'candidates' with upload/read policies + admin read all
- S2-007: CV upload (PDF, 5MB max, UUID rename, progress indicator) integrated into apply form
- S2-008: Progress bar on dashboard (5 steps: Candidature→Tests→Review→Entretien→Décision)
- **Learnings for future iterations:**
  - Supabase auth in static Astro: use client-side `<script>` with `createClient` per page
  - Protected routes: check `getSession()` in script, redirect to /login if null
  - DaisyUI `steps` component works well for progress bars
  - File upload to Supabase Storage: use `supabase.storage.from('bucket').upload(path, file)`
  - Unique constraint error code is '23505'
---

## 2026-02-09 - S4-001
- Created AdminLayout.astro with sidebar navigation, mobile drawer, admin role check
- Created /admin/index.astro dashboard page with stats cards, recent applications, quick links
- Sidebar links: Dashboard, Candidats, Postes, Vivier, Statistiques
- Admin auth: checks profile.role === 'admin', redirects non-admins to /dashboard
- Mobile: hamburger menu with drawer overlay
- Files changed: src/layouts/AdminLayout.astro (new), src/pages/admin/index.astro (new)
- **Learnings for future iterations:**
  - AdminLayout uses separate loading/app divs for auth check (same pattern as dashboard)
  - Admin pages use `noindex, nofollow` meta tag
  - Import path from admin pages: `../../layouts/AdminLayout.astro`
  - DaisyUI `drawer` with `lg:drawer-open` gives permanent sidebar on desktop, overlay on mobile
  - Supabase `select('*', { count: 'exact', head: true })` returns count without data
---

## 2026-02-09 - Sprint 4 Summary (S4-002 to S4-012)
- S4-002: Admin dashboard (stats + recent apps) — already built in S4-001
- S4-003: Admin candidates list with filters (job, status, country), search, sorting, pagination
- S4-004: Admin candidate detail page with profile info, test results, CV download, status change, notes
- S4-005: Admin jobs management with CRUD, grouped by title, status change, duplicate for country
- S4-006: Human scoring interface (6 criteria from SCORECARD, 1-5 each, /30 total, upsert)
- S4-007: Vapi integration edge function with 2 scenario prompts (easy/medium)
- S4-008: Roleplay candidate interface with consent modal, call timer, Vapi web call
- S4-009: Audio player + transcript display on admin candidate detail
- S4-010: Bulk actions (reject/pool/advance) with checkboxes, confirmation modal
- S4-011: Kanban view toggle with columns per status, card badges
- S4-012: CSV export with BOM for UTF-8 French characters
- **Learnings for future iterations:**
  - Static Astro can't use dynamic [id] routes for DB-driven IDs; use query params instead (?id=xxx)
  - Supabase `upsert` needs unique index on conflict columns
  - DaisyUI `dialog` element with `showModal()` is clean for modals (no JS framework needed)
  - DaisyUI `rating` component uses radio inputs for star ratings
  - CSV export: BOM (\uFEFF) is needed for Excel to read UTF-8 French chars
  - Edge functions: use Deno imports from esm.sh for npm packages
  - Bulk operations: iterate with individual updates rather than batched for error tracking
---

## 2026-02-09 - S6-006
- Setup GitHub Pages deployment with GitHub Actions workflow
- Created `.github/workflows/deploy.yml`: build on push to main, deploy via actions/deploy-pages@v4
- Added `public/CNAME` with `ambitia.io` for custom domain support
- `astro.config.mjs` already had `site: 'https://ambitia.io'` configured
- Workflow passes `PUBLIC_*` env vars from GitHub Secrets during build
- Files changed: .github/workflows/deploy.yml (new), public/CNAME (new), astro.config.mjs (site field)
- **Learnings for future iterations:**
  - Astro defaults to `output: 'static'` — no explicit config needed for GitHub Pages
  - CNAME file goes in `public/` so Astro copies it to `dist/` during build
  - GitHub Pages needs `permissions: pages: write, id-token: write` in workflow
  - Use `actions/upload-pages-artifact@v3` + `actions/deploy-pages@v4` for Pages deployment
  - Concurrency group prevents overlapping deployments
---

## 2026-02-09 - S6-007
- Final pre-launch checklist completed
- Updated README.md with full setup instructions: tech stack, installation, configuration, deployment, project structure, routes
- Verified build: 23 pages generated without errors in 1.79s
- All pages: landing, jobs, about, auth, dashboard, profile, apply, tests (Big Five, Quiz, Roleplay), admin (dashboard, candidates, jobs, pool, stats), privacy, terms
- Only warning: benign DaisyUI @property CSS warning (not an error)
- Files changed: README.md (rewritten)
- **Learnings for future iterations:**
  - DaisyUI @property warning is cosmetic and doesn't affect functionality
  - Astro static build generates clean index.html per route for GitHub Pages compatibility
  - All 47 user stories across 6 sprints are now complete
---

## 2026-02-09 - Post-Audit Fixes
- **Audit performed by Nigel** identified several bugs and missing features
- Analysis showed most "critical" bugs were non-issues (wrong URLs tested, data exists, admin already hidden)
- Real fixes implemented:
  1. Custom 404 page (`src/pages/404.astro`) with AMBITIA branding
  2. Sitemap via `@astrojs/sitemap` — filters out private pages (admin, dashboard, tests, etc.)
  3. `public/robots.txt` — disallows admin, dashboard, test routes
  4. AMBITIA branded favicon (gradient blue-purple with letter A) replaces Astro default
  5. Forgot password page (`/forgot-password`) with Supabase `resetPasswordForEmail`
  6. Email confirmation page (`/confirm-email`) shown after signup
  7. "Mot de passe oublié ?" link added on login page
  8. Google OAuth button restyled (white bg + border, visible on all themes)
  9. Homepage hero: replaced text-only video placeholder with branded gradient illustration
  10. Signup redirects to `/confirm-email` after successful registration
- Build: 24 pages generated in 2.08s (was 21, now +3 new pages)
- Files changed: 7 modified + 4 new pages + robots.txt
- **Audit items that were NOT bugs:**
  - BUG-001 (routes 404): Audit tested old path-based URLs. Actual routes use query params.
  - BUG-002 (admin visible): AdminLayout already hides content with `class="hidden"` until admin JS check.
  - BUG-003 (no jobs): 7 jobs exist in DB, anon key reads them via RLS. Issue was audit timing.
  - BUG-007 (greeting name): Dashboard code has proper fallback chain (profile → metadata → email → 'candidat').
  - BUG-008 (profile toast): Success message starts hidden, only shown after form submit.
  - MISSING-008 (no seed data): 7 demo jobs already in Supabase.
- **Learnings for future iterations:**
  - Audit reports may test wrong URLs — always verify against actual code before fixing
  - Static site admin protection pattern: content in `class="hidden"` div, shown by JS after auth check
  - `@astrojs/sitemap` filter function takes page URL string, return true to include
  - Supabase `resetPasswordForEmail` needs `redirectTo` option for the reset link
  - GitHub Pages uses 404.html at root — Astro generates it from src/pages/404.astro
---
