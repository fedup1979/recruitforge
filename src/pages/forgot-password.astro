---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Mot de passe oublié — AMBITIA" description="Réinitialisez votre mot de passe AMBITIA.">
  <section class="py-16 px-4">
    <div class="max-w-sm mx-auto">
      <h1 class="text-3xl font-bold text-base-content text-center mb-4">Mot de passe oublié</h1>
      <p class="text-base-content/60 text-center mb-8">Entrez votre email pour recevoir un lien de réinitialisation.</p>

      <div id="auth-error" class="alert alert-error mb-4 hidden">
        <span id="auth-error-text"></span>
      </div>
      <div id="auth-success" class="alert alert-success mb-4 hidden">
        <span id="auth-success-text"></span>
      </div>

      <form id="reset-form" class="space-y-4">
        <div class="form-control">
          <label class="label" for="email">
            <span class="label-text">Email</span>
          </label>
          <input type="email" id="email" name="email" placeholder="votre@email.com" class="input input-bordered w-full" required />
        </div>
        <button type="submit" id="reset-submit" class="btn btn-primary w-full">
          Envoyer le lien
        </button>
      </form>

      <p class="text-center text-sm text-base-content/60 mt-6">
        <a href="/login" class="link link-primary">Retour à la connexion</a>
      </p>
    </div>
  </section>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  const errorDiv = document.getElementById('auth-error') as HTMLDivElement;
  const errorText = document.getElementById('auth-error-text') as HTMLSpanElement;
  const successDiv = document.getElementById('auth-success') as HTMLDivElement;
  const successText = document.getElementById('auth-success-text') as HTMLSpanElement;

  document.getElementById('reset-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('reset-submit') as HTMLButtonElement;
    const email = (document.getElementById('email') as HTMLInputElement).value;

    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');

    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/login`,
    });

    submitBtn.classList.remove('loading');
    submitBtn.disabled = false;

    if (error) {
      errorText.textContent = error.message;
      errorDiv.classList.remove('hidden');
    } else {
      successText.textContent = 'Si un compte existe avec cet email, vous recevrez un lien de réinitialisation.';
      successDiv.classList.remove('hidden');
      (document.getElementById('reset-form') as HTMLFormElement).reset();
    }
  });
</script>
