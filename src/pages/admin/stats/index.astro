---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Statistiques — AMBITIA Admin">
  <h1 class="text-2xl font-bold text-base-content mb-6">Statistiques du funnel</h1>

  <!-- Filters -->
  <div class="flex flex-wrap gap-3 mb-6">
    <select id="filter-job" class="select select-bordered select-sm">
      <option value="">Tous les postes</option>
    </select>
    <select id="filter-country" class="select select-bordered select-sm">
      <option value="">Tous les pays</option>
    </select>
    <div class="flex items-center gap-2">
      <input type="date" id="filter-from" class="input input-bordered input-sm" />
      <span class="text-sm text-base-content/50">à</span>
      <input type="date" id="filter-to" class="input input-bordered input-sm" />
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="flex items-center justify-center py-16">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>

  <!-- Stats content -->
  <div id="stats-content" class="hidden">
    <!-- Summary stats -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title text-xs">Total candidatures</div>
        <div class="stat-value text-lg" id="stat-total">0</div>
      </div>
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title text-xs">Taux d'embauche</div>
        <div class="stat-value text-lg text-success" id="stat-hire-rate">0%</div>
      </div>
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title text-xs">Taux de rejet</div>
        <div class="stat-value text-lg text-error" id="stat-reject-rate">0%</div>
      </div>
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title text-xs">En vivier</div>
        <div class="stat-value text-lg" id="stat-pool">0</div>
      </div>
    </div>

    <!-- Charts row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Funnel bar chart -->
      <div class="card bg-base-200">
        <div class="card-body">
          <h2 class="card-title text-base mb-2">Funnel de recrutement</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="funnel-canvas"></canvas>
          </div>
        </div>
      </div>

      <!-- Status distribution pie chart -->
      <div class="card bg-base-200">
        <div class="card-body">
          <h2 class="card-title text-base mb-2">Répartition des statuts</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="status-canvas"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Applications over time -->
    <div class="card bg-base-200 mb-8">
      <div class="card-body">
        <h2 class="card-title text-base mb-2">Candidatures dans le temps</h2>
        <div style="position: relative; height: 250px;">
          <canvas id="timeline-canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Conversion table -->
    <div class="card bg-base-200">
      <div class="card-body">
        <h2 class="card-title text-base mb-4">Taux de conversion</h2>
        <div class="overflow-x-auto">
          <table class="table table-sm">
            <thead>
              <tr><th>Étape</th><th>Entrées</th><th>Sorties</th><th>Conversion</th></tr>
            </thead>
            <tbody id="conversion-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

  <script>
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    let allApps: any[] = [];
    let funnelChart: any = null;
    let statusChart: any = null;
    let timelineChart: any = null;

    const stages = [
      { key: 'pending', label: 'Candidature', color: '#FBBD23' },
      { key: 'testing', label: 'Tests', color: '#36D399' },
      { key: 'review', label: 'Review', color: '#6C5CE7' },
      { key: 'interview', label: 'Entretien', color: '#00D9A3' },
      { key: 'hired', label: 'Embauché', color: '#36D399' },
    ];

    const allStatuses = [
      { key: 'pending', label: 'Candidature', color: '#FBBD23' },
      { key: 'testing', label: 'Tests', color: '#3ABFF8' },
      { key: 'review', label: 'Review', color: '#6C5CE7' },
      { key: 'interview', label: 'Entretien', color: '#00D9A3' },
      { key: 'hired', label: 'Embauché', color: '#36D399' },
      { key: 'rejected', label: 'Rejeté', color: '#F87272' },
      { key: 'pool', label: 'Vivier', color: '#A78BFA' },
    ];

    async function loadStats() {
      const { data: apps } = await supabase
        .from('applications')
        .select('id, status, created_at, profiles(country), jobs(title, country)')
        .order('created_at', { ascending: false });

      allApps = apps || [];

      // Populate filters
      const jobs = [...new Set(allApps.map((a: any) => a.jobs?.title).filter(Boolean))];
      const jobSelect = document.getElementById('filter-job') as HTMLSelectElement;
      jobs.forEach(j => {
        const opt = document.createElement('option');
        opt.value = j;
        opt.textContent = j;
        jobSelect.appendChild(opt);
      });

      const countries = [...new Set(allApps.map((a: any) => a.profiles?.country).filter(Boolean))];
      const countrySelect = document.getElementById('filter-country') as HTMLSelectElement;
      countries.sort().forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        countrySelect.appendChild(opt);
      });

      document.getElementById('loading')!.classList.add('hidden');
      document.getElementById('stats-content')!.classList.remove('hidden');

      renderStats();
    }

    function getFiltered(): any[] {
      const jobFilter = (document.getElementById('filter-job') as HTMLSelectElement).value;
      const countryFilter = (document.getElementById('filter-country') as HTMLSelectElement).value;
      const fromDate = (document.getElementById('filter-from') as HTMLInputElement).value;
      const toDate = (document.getElementById('filter-to') as HTMLInputElement).value;

      return allApps.filter((a: any) => {
        if (jobFilter && a.jobs?.title !== jobFilter) return false;
        if (countryFilter && a.profiles?.country !== countryFilter) return false;
        if (fromDate && a.created_at < fromDate) return false;
        if (toDate && a.created_at > toDate + 'T23:59:59') return false;
        return true;
      });
    }

    function renderStats() {
      const Chart = (window as any).Chart;
      if (!Chart) return;

      const filtered = getFiltered();
      const total = filtered.length;

      const statusOrder = ['pending', 'testing', 'review', 'interview', 'hired'];
      const counts: Record<string, number> = {};
      allStatuses.forEach(s => counts[s.key] = 0);
      filtered.forEach(a => { if (counts[a.status] !== undefined) counts[a.status]++; });

      const rejected = counts['rejected'] || 0;
      const pool = counts['pool'] || 0;

      // Funnel (cumulative)
      const funnelCounts: number[] = [];
      for (let i = 0; i < stages.length; i++) {
        let count = 0;
        for (let j = i; j < statusOrder.length; j++) {
          count += counts[statusOrder[j]];
        }
        funnelCounts.push(count);
      }
      funnelCounts[0] = total;

      // Funnel bar chart
      const funnelCtx = (document.getElementById('funnel-canvas') as HTMLCanvasElement).getContext('2d')!;
      if (funnelChart) funnelChart.destroy();
      funnelChart = new Chart(funnelCtx, {
        type: 'bar',
        data: {
          labels: stages.map(s => s.label),
          datasets: [{
            data: stages.map((_, i) => i === 0 ? total : funnelCounts[i]),
            backgroundColor: stages.map(s => s.color),
            borderRadius: 6,
            barPercentage: 0.7,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } },
          },
        },
      });

      // Status pie chart
      const statusCtx = (document.getElementById('status-canvas') as HTMLCanvasElement).getContext('2d')!;
      const pieData = allStatuses.filter(s => counts[s.key] > 0);
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: pieData.map(s => s.label),
          datasets: [{
            data: pieData.map(s => counts[s.key]),
            backgroundColor: pieData.map(s => s.color),
            borderWidth: 2,
            borderColor: 'oklch(var(--b2))',
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12, padding: 12 } },
          },
        },
      });

      // Timeline (applications per week)
      const timelineCtx = (document.getElementById('timeline-canvas') as HTMLCanvasElement).getContext('2d')!;
      const weekMap: Record<string, number> = {};
      filtered.forEach(a => {
        const d = new Date(a.created_at);
        const weekStart = new Date(d);
        weekStart.setDate(d.getDate() - d.getDay());
        const key = weekStart.toISOString().split('T')[0];
        weekMap[key] = (weekMap[key] || 0) + 1;
      });
      const sortedWeeks = Object.keys(weekMap).sort();
      if (timelineChart) timelineChart.destroy();
      timelineChart = new Chart(timelineCtx, {
        type: 'line',
        data: {
          labels: sortedWeeks.map(w => {
            const d = new Date(w);
            return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
          }),
          datasets: [{
            label: 'Candidatures',
            data: sortedWeeks.map(w => weekMap[w]),
            borderColor: '#2D5BFF',
            backgroundColor: 'rgba(45, 91, 255, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#2D5BFF',
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } },
          },
        },
      });

      // Conversion table
      const convTable = document.getElementById('conversion-table')!;
      convTable.innerHTML = stages.slice(0, -1).map((stage, i) => {
        const from = i === 0 ? total : funnelCounts[i];
        const to = funnelCounts[i + 1];
        const rate = from > 0 ? Math.round((to / from) * 100) : 0;
        return `
          <tr>
            <td>${stage.label} → ${stages[i + 1].label}</td>
            <td>${from}</td>
            <td>${to}</td>
            <td><span class="font-bold ${rate >= 50 ? 'text-success' : rate >= 25 ? 'text-warning' : 'text-error'}">${rate}%</span></td>
          </tr>
        `;
      }).join('');

      // Summary stats
      document.getElementById('stat-total')!.textContent = String(total);
      const hiredCount = counts['hired'] || 0;
      document.getElementById('stat-hire-rate')!.textContent = total > 0 ? Math.round((hiredCount / total) * 100) + '%' : '0%';
      document.getElementById('stat-reject-rate')!.textContent = total > 0 ? Math.round((rejected / total) * 100) + '%' : '0%';
      document.getElementById('stat-pool')!.textContent = String(pool);
    }

    document.getElementById('filter-job')!.addEventListener('change', renderStats);
    document.getElementById('filter-country')!.addEventListener('change', renderStats);
    document.getElementById('filter-from')!.addEventListener('change', renderStats);
    document.getElementById('filter-to')!.addEventListener('change', renderStats);

    loadStats();
  </script>
</AdminLayout>
