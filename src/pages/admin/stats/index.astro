---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Statistiques — AMBITIA Admin">
  <h1 class="text-2xl font-bold text-base-content mb-6">Statistiques du funnel</h1>

  <!-- Filters -->
  <div class="flex flex-wrap gap-3 mb-6">
    <select id="filter-job" class="select select-bordered select-sm">
      <option value="">Tous les postes</option>
    </select>
    <select id="filter-country" class="select select-bordered select-sm">
      <option value="">Tous les pays</option>
    </select>
    <div class="flex items-center gap-2">
      <input type="date" id="filter-from" class="input input-bordered input-sm" />
      <span class="text-sm text-base-content/50">à</span>
      <input type="date" id="filter-to" class="input input-bordered input-sm" />
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="flex items-center justify-center py-16">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>

  <!-- Stats content -->
  <div id="stats-content" class="hidden">
    <!-- Funnel visualization -->
    <div class="card bg-base-200 mb-8">
      <div class="card-body">
        <h2 class="card-title text-base mb-4">Funnel de recrutement</h2>
        <div id="funnel-chart" class="space-y-3">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Conversion rates -->
    <div class="card bg-base-200 mb-8">
      <div class="card-body">
        <h2 class="card-title text-base mb-4">Taux de conversion</h2>
        <div class="overflow-x-auto">
          <table class="table table-sm">
            <thead>
              <tr><th>Étape</th><th>Entrées</th><th>Sorties</th><th>Conversion</th></tr>
            </thead>
            <tbody id="conversion-table">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Summary stats -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title text-xs">Total candidatures</div>
        <div class="stat-value text-lg" id="stat-total">0</div>
      </div>
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title text-xs">Taux d'embauche</div>
        <div class="stat-value text-lg text-success" id="stat-hire-rate">0%</div>
      </div>
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title text-xs">Taux de rejet</div>
        <div class="stat-value text-lg text-error" id="stat-reject-rate">0%</div>
      </div>
      <div class="stat bg-base-200 rounded-box">
        <div class="stat-title text-xs">En vivier</div>
        <div class="stat-value text-lg" id="stat-pool">0</div>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    let allApps: any[] = [];

    const stages = [
      { key: 'pending', label: 'Candidature', color: 'bg-warning' },
      { key: 'testing', label: 'Tests', color: 'bg-info' },
      { key: 'review', label: 'Review', color: 'bg-secondary' },
      { key: 'interview', label: 'Entretien', color: 'bg-accent' },
      { key: 'hired', label: 'Embauché', color: 'bg-success' },
    ];

    async function loadStats() {
      const { data: apps } = await supabase
        .from('applications')
        .select('id, status, created_at, profiles(country), jobs(title, country)')
        .order('created_at', { ascending: false });

      allApps = apps || [];

      // Populate filters
      const jobs = [...new Set(allApps.map((a: any) => a.jobs?.title).filter(Boolean))];
      const jobSelect = document.getElementById('filter-job') as HTMLSelectElement;
      jobs.forEach(j => {
        const opt = document.createElement('option');
        opt.value = j;
        opt.textContent = j;
        jobSelect.appendChild(opt);
      });

      const countries = [...new Set(allApps.map((a: any) => a.profiles?.country).filter(Boolean))];
      const countrySelect = document.getElementById('filter-country') as HTMLSelectElement;
      countries.sort().forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        countrySelect.appendChild(opt);
      });

      document.getElementById('loading')!.classList.add('hidden');
      document.getElementById('stats-content')!.classList.remove('hidden');

      renderStats();
    }

    function getFiltered(): any[] {
      const jobFilter = (document.getElementById('filter-job') as HTMLSelectElement).value;
      const countryFilter = (document.getElementById('filter-country') as HTMLSelectElement).value;
      const fromDate = (document.getElementById('filter-from') as HTMLInputElement).value;
      const toDate = (document.getElementById('filter-to') as HTMLInputElement).value;

      return allApps.filter((a: any) => {
        if (jobFilter && a.jobs?.title !== jobFilter) return false;
        if (countryFilter && a.profiles?.country !== countryFilter) return false;
        if (fromDate && a.created_at < fromDate) return false;
        if (toDate && a.created_at > toDate + 'T23:59:59') return false;
        return true;
      });
    }

    function renderStats() {
      const filtered = getFiltered();
      const total = filtered.length;

      // Count per stage (cumulative: anyone who reached this stage or beyond)
      const statusOrder = ['pending', 'testing', 'review', 'interview', 'hired'];
      const statusIndex: Record<string, number> = {};
      statusOrder.forEach((s, i) => statusIndex[s] = i);
      // rejected and pool don't fit neatly, count them separately
      const rejected = filtered.filter(a => a.status === 'rejected').length;
      const pool = filtered.filter(a => a.status === 'pool').length;

      // Count currently at each stage
      const counts: Record<string, number> = {};
      statusOrder.forEach(s => counts[s] = 0);
      filtered.forEach(a => {
        if (statusOrder.includes(a.status)) {
          counts[a.status]++;
        }
      });

      // For funnel: cumulative (everyone who reached stage or beyond)
      const cumulative: number[] = [];
      let runningTotal = total - rejected - pool; // only count active funnel
      // All active candidates started at pending
      const activeTotal = total;

      // Funnel bars
      const funnelChart = document.getElementById('funnel-chart')!;
      const maxCount = activeTotal || 1;

      // Cumulative funnel: all candidates reached pending; those at testing+ reached testing, etc.
      const funnelCounts: number[] = [];
      for (let i = 0; i < stages.length; i++) {
        // Candidates at this stage or later
        let count = 0;
        for (let j = i; j < statusOrder.length; j++) {
          count += counts[statusOrder[j]];
        }
        funnelCounts.push(count);
      }
      // But the first stage should include everyone (including rejected/pool who passed through)
      funnelCounts[0] = total;

      funnelChart.innerHTML = stages.map((stage, i) => {
        const count = i === 0 ? total : funnelCounts[i];
        const pct = total > 0 ? Math.round((count / total) * 100) : 0;
        const barWidth = total > 0 ? Math.max(5, Math.round((count / total) * 100)) : 5;

        return `
          <div class="flex items-center gap-4">
            <div class="w-24 text-sm font-medium text-right">${stage.label}</div>
            <div class="flex-1">
              <div class="${stage.color} rounded-full h-8 flex items-center px-3 transition-all" style="width: ${barWidth}%">
                <span class="text-white text-xs font-bold">${count}</span>
              </div>
            </div>
            <div class="w-12 text-sm text-base-content/50 text-right">${pct}%</div>
          </div>
        `;
      }).join('');

      // Conversion table
      const convTable = document.getElementById('conversion-table')!;
      convTable.innerHTML = stages.slice(0, -1).map((stage, i) => {
        const from = i === 0 ? total : funnelCounts[i];
        const to = funnelCounts[i + 1];
        const rate = from > 0 ? Math.round((to / from) * 100) : 0;
        return `
          <tr>
            <td>${stage.label} → ${stages[i + 1].label}</td>
            <td>${from}</td>
            <td>${to}</td>
            <td><span class="font-bold ${rate >= 50 ? 'text-success' : rate >= 25 ? 'text-warning' : 'text-error'}">${rate}%</span></td>
          </tr>
        `;
      }).join('');

      // Summary stats
      document.getElementById('stat-total')!.textContent = String(total);
      const hiredCount = counts['hired'] || 0;
      document.getElementById('stat-hire-rate')!.textContent = total > 0 ? Math.round((hiredCount / total) * 100) + '%' : '0%';
      document.getElementById('stat-reject-rate')!.textContent = total > 0 ? Math.round((rejected / total) * 100) + '%' : '0%';
      document.getElementById('stat-pool')!.textContent = String(pool);
    }

    document.getElementById('filter-job')!.addEventListener('change', renderStats);
    document.getElementById('filter-country')!.addEventListener('change', renderStats);
    document.getElementById('filter-from')!.addEventListener('change', renderStats);
    document.getElementById('filter-to')!.addEventListener('change', renderStats);

    loadStats();
  </script>
</AdminLayout>
