---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Détail candidat — AMBITIA Admin">
  <!-- Loading -->
  <div id="loading" class="flex items-center justify-center py-16">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>

  <!-- Not found -->
  <div id="not-found" class="text-center py-16 hidden">
    <h2 class="text-xl font-semibold text-base-content/50 mb-2">Candidature introuvable</h2>
    <a href="/admin/candidates" class="btn btn-primary btn-sm mt-4">Retour à la liste</a>
  </div>

  <!-- Detail content -->
  <div id="detail" class="hidden">
    <div class="flex items-center gap-2 mb-6">
      <a href="/admin/candidates" class="btn btn-ghost btn-sm">← Retour</a>
    </div>

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
      <div>
        <h1 class="text-2xl font-bold text-base-content" id="candidate-name">—</h1>
        <p class="text-base-content/60" id="candidate-email">—</p>
      </div>
      <div class="flex items-center gap-3">
        <select id="status-select" class="select select-bordered select-sm">
          <option value="pending">En attente</option>
          <option value="testing">Tests</option>
          <option value="review">Review</option>
          <option value="interview">Entretien</option>
          <option value="hired">Embauché</option>
          <option value="rejected">Refusé</option>
          <option value="pool">Vivier</option>
        </select>
        <button id="save-status" class="btn btn-primary btn-sm">Sauvegarder</button>
      </div>
    </div>

    <!-- Composite score banner -->
    <div id="composite-banner" class="hidden mb-6">
      <div class="card bg-primary/10 border border-primary/20">
        <div class="card-body py-4 flex-row items-center justify-between">
          <div>
            <h2 class="font-bold text-base-content">Score composite</h2>
            <p class="text-sm text-base-content/60" id="composite-breakdown"></p>
          </div>
          <div class="text-right">
            <span class="text-3xl font-bold text-primary" id="composite-score">—</span>
            <span class="text-base-content/50">/100</span>
            <span id="composite-verdict" class="badge ml-2"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Info grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- Profile info -->
      <div class="card bg-base-200">
        <div class="card-body">
          <h2 class="card-title text-base">Profil</h2>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-base-content/60">Téléphone</span><span id="info-phone">—</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Pays</span><span id="info-country">—</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Rôle</span><span id="info-role">—</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Inscription</span><span id="info-created">—</span></div>
          </div>
        </div>
      </div>

      <!-- Application info -->
      <div class="card bg-base-200">
        <div class="card-body">
          <h2 class="card-title text-base">Candidature</h2>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-base-content/60">Poste</span><span id="info-job">—</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Pays du poste</span><span id="info-job-country">—</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Date de candidature</span><span id="info-app-date">—</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Statut</span><span id="info-status" class="badge badge-sm">—</span></div>
          </div>
          <div class="mt-3" id="cv-container">
            <!-- CV link if available -->
          </div>
          <!-- Parsed CV data -->
          <div id="parsed-cv" class="hidden mt-3">
            <div class="divider my-1"></div>
            <p class="text-xs text-base-content/50 mb-2">Données extraites du CV (IA)</p>
            <div id="parsed-cv-content" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Knockout answers -->
    <div class="card bg-base-200 mb-6" id="knockout-section">
      <div class="card-body">
        <h2 class="card-title text-base">Réponses de présélection</h2>
        <div id="knockout-answers" class="space-y-2 text-sm">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Test results -->
    <div class="card bg-base-200 mb-6" id="tests-section">
      <div class="card-body">
        <h2 class="card-title text-base">Résultats des tests</h2>
        <div id="test-results" class="space-y-3">
          <!-- Populated by JS -->
        </div>
        <div id="no-tests" class="text-base-content/50 text-sm hidden">Aucun test complété.</div>
      </div>
    </div>

    <!-- Video presentation -->
    <div class="card bg-base-200 mb-6" id="video-section">
      <div class="card-body">
        <h2 class="card-title text-base">Présentation vidéo</h2>
        <div id="video-player-container" class="hidden">
          <!-- Video player inserted by JS -->
        </div>
        <div id="video-transcript" class="hidden mt-3">
          <p class="text-xs text-base-content/50 mb-1">Transcription</p>
          <div class="bg-base-100 rounded-box p-3 text-sm max-h-48 overflow-y-auto whitespace-pre-wrap" id="video-transcript-text"></div>
        </div>
        <div id="no-video" class="text-base-content/50 text-sm">Aucune vidéo de présentation.</div>
      </div>
    </div>

    <!-- Roleplay recordings -->
    <div class="card bg-base-200 mb-6" id="roleplay-section">
      <div class="card-body">
        <h2 class="card-title text-base">Enregistrements Roleplay</h2>
        <div id="roleplay-recordings" class="space-y-4">
          <!-- Populated by JS -->
        </div>
        <div id="no-recordings" class="text-base-content/50 text-sm hidden">Aucun enregistrement disponible.</div>
      </div>
    </div>

    <!-- Dynamic evaluation grids -->
    <div id="evaluation-grids" class="space-y-6 mb-6">
      <!-- Populated by JS -->
    </div>

    <!-- Notes -->
    <div class="card bg-base-200 mb-6">
      <div class="card-body">
        <h2 class="card-title text-base">Notes internes</h2>
        <textarea id="notes-input" class="textarea textarea-bordered w-full" rows="4" placeholder="Ajouter des notes sur ce candidat…"></textarea>
        <div class="card-actions justify-end mt-2">
          <button id="save-notes" class="btn btn-sm btn-outline">Enregistrer les notes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const params = new URLSearchParams(window.location.search);
    const appId = params.get('id');

    const statusLabels: Record<string, { label: string; class: string }> = {
      pending: { label: 'En attente', class: 'badge-warning' },
      testing: { label: 'Tests', class: 'badge-info' },
      review: { label: 'Review', class: 'badge-secondary' },
      interview: { label: 'Entretien', class: 'badge-accent' },
      hired: { label: 'Embauché', class: 'badge-success' },
      rejected: { label: 'Refusé', class: 'badge-error' },
      pool: { label: 'Vivier', class: 'badge-neutral' },
    };

    async function loadDetail() {
      if (!appId) {
        document.getElementById('loading')!.classList.add('hidden');
        document.getElementById('not-found')!.classList.remove('hidden');
        return;
      }

      const { data: app, error } = await supabase
        .from('applications')
        .select(`
          id, status, created_at, knockout_answers, admin_notes, job_id,
          profiles(id, full_name, email, phone, country, role, created_at),
          jobs(id, title, country, salary_label),
          test_results(test_type, score, result_data, completed_at)
        `)
        .eq('id', appId)
        .single();

      document.getElementById('loading')!.classList.add('hidden');

      if (error || !app) {
        document.getElementById('not-found')!.classList.remove('hidden');
        return;
      }

      document.getElementById('detail')!.classList.remove('hidden');

      const profile = app.profiles as any;
      const job = app.jobs as any;
      const status = statusLabels[app.status] || { label: app.status, class: 'badge-ghost' };

      // Header
      document.getElementById('candidate-name')!.textContent = profile?.full_name || 'Candidat';
      document.getElementById('candidate-email')!.textContent = profile?.email || '';
      (document.getElementById('status-select') as HTMLSelectElement).value = app.status;

      // Profile info
      document.getElementById('info-phone')!.textContent = profile?.phone || '—';
      document.getElementById('info-country')!.textContent = profile?.country || '—';
      document.getElementById('info-role')!.textContent = profile?.role || '—';
      document.getElementById('info-created')!.textContent = profile?.created_at
        ? new Date(profile.created_at).toLocaleDateString('fr-FR')
        : '—';

      // Application info
      document.getElementById('info-job')!.textContent = job?.title || '—';
      document.getElementById('info-job-country')!.textContent = job?.country || '—';
      document.getElementById('info-app-date')!.textContent = new Date(app.created_at).toLocaleDateString('fr-FR');
      const statusBadge = document.getElementById('info-status')!;
      statusBadge.textContent = status.label;
      statusBadge.className = `badge badge-sm ${status.class}`;

      // CV download
      const cvContainer = document.getElementById('cv-container')!;
      if (profile?.id) {
        const { data: files } = await supabase.storage
          .from('candidates')
          .list(`${profile.id}/cv`);

        if (files && files.length > 0) {
          const { data: urlData } = await supabase.storage
            .from('candidates')
            .createSignedUrl(`${profile.id}/cv/${files[0].name}`, 3600);

          if (urlData?.signedUrl) {
            cvContainer.innerHTML = `<a href="${urlData.signedUrl}" target="_blank" class="btn btn-outline btn-sm">Télécharger le CV</a>`;
          }
        }
      }

      // Load parsed CV data from candidate_documents
      if (profile?.id) {
        const { data: cvDocs } = await supabase
          .from('candidate_documents')
          .select('metadata')
          .eq('user_id', profile.id)
          .eq('doc_type', 'cv')
          .order('created_at', { ascending: false })
          .limit(1);

        if (cvDocs?.[0]?.metadata?.parsed) {
          const parsed = cvDocs[0].metadata.parsed as any;
          const parsedDiv = document.getElementById('parsed-cv')!;
          const contentDiv = document.getElementById('parsed-cv-content')!;
          parsedDiv.classList.remove('hidden');

          let html = '';

          if (parsed.summary) {
            html += `<p class="text-base-content/70 italic">${parsed.summary}</p>`;
          }

          if (parsed.skills?.length > 0) {
            html += `<div><span class="text-xs text-base-content/50">Compétences</span><div class="flex flex-wrap gap-1 mt-1">${
              parsed.skills.map((s: string) => `<span class="badge badge-sm badge-outline">${s}</span>`).join('')
            }</div></div>`;
          }

          if (parsed.experience?.length > 0) {
            html += `<div><span class="text-xs text-base-content/50">Expérience</span><div class="space-y-1 mt-1">${
              parsed.experience.map((e: any) =>
                `<div class="bg-base-100 rounded px-2 py-1"><span class="font-medium text-xs">${e.title}</span> <span class="text-xs text-base-content/50">— ${e.company} (${e.dates})</span></div>`
              ).join('')
            }</div></div>`;
          }

          if (parsed.education?.length > 0) {
            html += `<div><span class="text-xs text-base-content/50">Formation</span><div class="space-y-1 mt-1">${
              parsed.education.map((e: any) =>
                `<div class="bg-base-100 rounded px-2 py-1"><span class="font-medium text-xs">${e.degree}</span> <span class="text-xs text-base-content/50">— ${e.school} (${e.dates})</span></div>`
              ).join('')
            }</div></div>`;
          }

          if (parsed.languages?.length > 0) {
            html += `<div><span class="text-xs text-base-content/50">Langues</span><div class="flex flex-wrap gap-1 mt-1">${
              parsed.languages.map((l: string) => `<span class="badge badge-sm badge-ghost">${l}</span>`).join('')
            }</div></div>`;
          }

          contentDiv.innerHTML = html;
        }
      }

      // Knockout answers
      const knockoutDiv = document.getElementById('knockout-answers')!;
      if (app.knockout_answers && typeof app.knockout_answers === 'object') {
        const answers = app.knockout_answers as Record<string, any>;
        const questionLabels: Record<string, string> = {
          availability: 'Disponibilité Lun-Ven 9h-18h',
          internet: 'Connexion internet stable',
          french_level: 'Niveau de français',
          call_experience: 'Expérience en appels',
        };
        knockoutDiv.innerHTML = Object.entries(answers).map(([key, val]) =>
          `<div class="flex justify-between"><span class="text-base-content/60">${questionLabels[key] || key}</span><span class="font-medium">${val}</span></div>`
        ).join('');
      } else {
        document.getElementById('knockout-section')!.classList.add('hidden');
      }

      // Test results
      const testResults = (app.test_results || []) as any[];
      const testDiv = document.getElementById('test-results')!;
      const noTests = document.getElementById('no-tests')!;

      if (testResults.length === 0) {
        noTests.classList.remove('hidden');
      } else {
        testDiv.innerHTML = testResults.map((t: any) => {
          const typeLabels: Record<string, string> = {
            big_five: 'Big Five', quiz: 'Quiz produit', human_score: 'Score humain',
            composite: 'Score composite', intelligence: 'Test d\'intelligence',
            roleplay: 'Roleplay', roleplay_easy: 'Roleplay (facile)', roleplay_medium: 'Roleplay (moyen)',
            video_presentation: 'Présentation vidéo',
          };
          const typeLabel = typeLabels[t.test_type] || t.test_type;
          const date = t.completed_at ? new Date(t.completed_at).toLocaleDateString('fr-FR') : '—';
          let details = '';

          if (t.test_type === 'big_five' && t.result_data) {
            const rd = t.result_data as any;
            if (rd.domains) {
              const domainLabels: Record<string, string> = {
                N: 'Névrosisme', E: 'Extraversion', O: 'Ouverture', A: 'Agréabilité', C: 'Conscienciosité',
              };
              const domainColors: Record<string, string> = {
                N: '#EF4444', E: '#F59E0B', O: '#8B5CF6', A: '#10B981', C: '#3B82F6',
              };
              details = `<div class="space-y-2 mt-2">${
                Object.entries(rd.domains).map(([key, val]: [string, any]) =>
                  `<div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 rounded-full" style="background:${domainColors[key] || '#888'}"></div>
                      <span class="text-base-content/70">${domainLabels[key] || key}</span>
                    </div>
                    <span class="font-bold">${val.score}/100</span>
                  </div>`
                ).join('')
              }</div>`;
            } else {
              const traits = rd as Record<string, number>;
              details = `<div class="grid grid-cols-5 gap-2 mt-2">${
                Object.entries(traits).map(([trait, score]) =>
                  `<div class="text-center"><div class="text-xs text-base-content/50">${trait}</div><div class="font-bold text-sm">${score}</div></div>`
                ).join('')
              }</div>`;
            }
          }

          if (t.test_type === 'intelligence' && t.result_data) {
            const rd = t.result_data as any;
            details = `<div class="text-sm mt-2 text-base-content/70">${rd.correct || 0}/${rd.total || 0} réponses correctes</div>`;
          }

          return `
            <div class="bg-base-100 rounded-box p-3">
              <div class="flex items-center justify-between">
                <span class="font-medium text-sm">${typeLabel}</span>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-base-content/50">${date}</span>
                  ${t.score !== null ? `<span class="badge badge-sm badge-primary">${t.score}%</span>` : ''}
                </div>
              </div>
              ${details}
            </div>
          `;
        }).join('');
      }

      // Video presentation display
      const videoTest = testResults.find((t: any) => t.test_type === 'video_presentation');
      if (videoTest?.result_data?.storage_path) {
        const { data: videoUrl } = await supabase.storage
          .from('candidates')
          .createSignedUrl(videoTest.result_data.storage_path, 3600);
        if (videoUrl?.signedUrl) {
          document.getElementById('no-video')!.classList.add('hidden');
          const container = document.getElementById('video-player-container')!;
          container.classList.remove('hidden');
          const mimeType = videoTest.result_data.mime_type || 'video/webm';
          container.innerHTML = `
            <video controls class="w-full rounded-lg" preload="metadata">
              <source src="${videoUrl.signedUrl}" type="${mimeType}" />
              Votre navigateur ne supporte pas la lecture vidéo.
            </video>
            <p class="text-xs text-base-content/50 mt-2">Enregistrée le ${videoTest.completed_at ? new Date(videoTest.completed_at).toLocaleDateString('fr-FR') : '—'}</p>
          `;
        }
        // Show transcript if available
        if (videoTest.result_data.transcript) {
          document.getElementById('video-transcript')!.classList.remove('hidden');
          document.getElementById('video-transcript-text')!.textContent = videoTest.result_data.transcript;
        }
      }

      // Roleplay recordings
      const roleplayTests = testResults.filter((t: any) => t.test_type?.startsWith('roleplay_'));
      const recordingsDiv = document.getElementById('roleplay-recordings')!;
      const noRecordings = document.getElementById('no-recordings')!;

      if (roleplayTests.length === 0) {
        noRecordings.classList.remove('hidden');
      } else {
        recordingsDiv.innerHTML = roleplayTests.map((t: any) => {
          const data = t.result_data || {};
          const scenarioName = data.scenario_name || t.test_type;
          const date = t.completed_at ? new Date(t.completed_at).toLocaleDateString('fr-FR') : '—';
          const transcript = data.transcript || '';
          const audioUrl = data.recording_url || '';

          let audioHtml = '';
          if (audioUrl) {
            audioHtml = `
              <div class="mt-3">
                <p class="text-xs text-base-content/50 mb-1">Enregistrement audio</p>
                <audio controls class="w-full" preload="metadata">
                  <source src="${audioUrl}" type="audio/mpeg" />
                  Votre navigateur ne supporte pas la lecture audio.
                </audio>
              </div>
            `;
          }

          let transcriptHtml = '';
          if (transcript) {
            transcriptHtml = `
              <div class="mt-3">
                <p class="text-xs text-base-content/50 mb-1">Transcription</p>
                <div class="bg-base-100 rounded-box p-3 text-sm max-h-48 overflow-y-auto whitespace-pre-wrap">${transcript}</div>
              </div>
            `;
          }

          return `
            <div class="bg-base-100 rounded-box p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-sm">${scenarioName}</span>
                <span class="text-xs text-base-content/50">${date}</span>
              </div>
              ${audioHtml}
              ${transcriptHtml}
              ${!audioUrl && !transcript ? '<p class="text-xs text-base-content/40">Enregistrement en attente de traitement...</p>' : ''}
            </div>
          `;
        }).join('');
      }

      // Composite score display
      const compositeTest = testResults.find((t: any) => t.test_type === 'composite');
      if (compositeTest) {
        document.getElementById('composite-banner')!.classList.remove('hidden');
        document.getElementById('composite-score')!.textContent = String(compositeTest.score);
        const breakdown = compositeTest.result_data as any;
        if (breakdown) {
          const parts = [`Big Five: ${breakdown.big_five ?? '—'}%`];
          if (breakdown.intelligence != null) parts.push(`Intelligence: ${breakdown.intelligence}%`);
          parts.push(`Quiz: ${breakdown.quiz ?? '—'}%`, `Profil: ${breakdown.profile ?? '—'}%`);
          document.getElementById('composite-breakdown')!.textContent = parts.join(' | ');
        }
        const verdict = document.getElementById('composite-verdict')!;
        if (compositeTest.score >= 70) {
          verdict.textContent = 'Fast-track';
          verdict.className = 'badge badge-success ml-2';
        } else if (compositeTest.score >= 40) {
          verdict.textContent = 'Review';
          verdict.className = 'badge badge-warning ml-2';
        } else {
          verdict.textContent = 'Rejeté';
          verdict.className = 'badge badge-error ml-2';
        }
      }

      // Dynamic evaluation grids — load from test_definitions with criteria
      await loadEvaluationGrids(app.job_id, testResults);

      // Notes
      const notesInput = document.getElementById('notes-input') as HTMLTextAreaElement;
      notesInput.value = (app as any).admin_notes || '';

      // Save status handler
      document.getElementById('save-status')!.addEventListener('click', async () => {
        const { data: { session: adminSession } } = await supabase.auth.getSession();
        if (!adminSession) return;

        const newStatus = (document.getElementById('status-select') as HTMLSelectElement).value;
        const { error: updateError } = await supabase
          .from('applications')
          .update({ status: newStatus })
          .eq('id', appId);

        if (updateError) {
          alert('Erreur: ' + updateError.message);
        } else {
          const s = statusLabels[newStatus] || { label: newStatus, class: 'badge-ghost' };
          const badge = document.getElementById('info-status')!;
          badge.textContent = s.label;
          badge.className = `badge badge-sm ${s.class}`;

          // Send email notification to candidate
          const templateMap: Record<string, string> = {
            interview: 'status_interview',
            hired: 'status_hired',
            rejected: 'status_rejected',
            pool: 'status_pool',
            review: 'status_review',
          };
          const emailTemplate = templateMap[newStatus];
          if (emailTemplate && profile?.email) {
            try {
              await fetch(
                `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/send-email`,
                {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${adminSession.access_token}`,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    template: emailTemplate,
                    to: profile.email,
                    data: {
                      name: profile.full_name || 'Candidat',
                      jobTitle: job?.title || 'poste',
                      status: s.label,
                    },
                  }),
                }
              );
            } catch {}
          }

          alert('Statut mis à jour.' + (emailTemplate ? ' Email envoyé au candidat.' : ''));
        }
      });

      // Save notes handler
      document.getElementById('save-notes')!.addEventListener('click', async () => {
        const notes = notesInput.value;
        const { error: notesError } = await supabase
          .from('applications')
          .update({ admin_notes: notes })
          .eq('id', appId);

        if (notesError) {
          alert('Erreur: ' + notesError.message);
        } else {
          alert('Notes enregistrées.');
        }
      });
    }

    // ============================================================
    // Dynamic evaluation grids
    // ============================================================
    async function loadEvaluationGrids(jobId: string, testResults: any[]) {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      // Load test definitions that have criteria in their config
      const { data: testDefs } = await supabase
        .from('test_definitions')
        .select('id, slug, label, config')
        .filter('config', 'neq', '{}');

      if (!testDefs) return;

      const evaluableTests = testDefs.filter(td => td.config?.criteria?.length > 0);
      if (evaluableTests.length === 0) return;

      // Load existing evaluations for this application
      const { data: existingEvals } = await supabase
        .from('evaluations')
        .select('*')
        .eq('application_id', appId);

      // Also load legacy human_score from test_results (backward compatibility)
      const legacyHumanScore = testResults.find(t => t.test_type === 'human_score');

      const gridsContainer = document.getElementById('evaluation-grids')!;

      for (const testDef of evaluableTests) {
        const criteria: Array<{ key: string; label: string; description: string }> = testDef.config.criteria;
        const myEval = (existingEvals || []).find(
          (e: any) => e.test_definition_id === testDef.id && e.evaluator_id === session.user.id
        );
        const allEvals = (existingEvals || []).filter(
          (e: any) => e.test_definition_id === testDef.id
        );

        // For roleplay, check if we have a legacy human_score to pre-populate
        let preScores: Record<string, number> = {};
        if (myEval?.scores) {
          preScores = myEval.scores;
        } else if (testDef.slug === 'roleplay' && legacyHumanScore?.result_data) {
          preScores = legacyHumanScore.result_data;
        }

        const gridId = `eval-grid-${testDef.slug}`;
        const maxScore = criteria.length * 5;

        const gridHtml = `
          <div class="card bg-base-200" id="${gridId}">
            <div class="card-body">
              <h2 class="card-title text-base">Grille d'évaluation — ${testDef.label}</h2>
              <div class="flex items-center justify-between mb-3">
                <p class="text-xs text-base-content/50">Score chaque critère de 1 (faible) à 5 (excellent).</p>
                <button class="btn btn-ghost btn-xs text-error eval-reset-all" data-grid="${gridId}">Tout réinitialiser</button>
              </div>
              ${allEvals.length > 1 ? `
                <div class="alert alert-info mb-3 py-2">
                  <span class="text-xs">${allEvals.length} évaluateurs ont noté ce test.</span>
                </div>
              ` : ''}
              <div class="space-y-3 eval-criteria" data-grid="${gridId}">
                ${criteria.map(c => `
                  <div class="flex items-center justify-between gap-4" data-criterion="${c.key}">
                    <div class="min-w-[140px]">
                      <span class="font-medium text-sm">${c.label}</span>
                      <p class="text-xs text-base-content/40">${c.description}</p>
                    </div>
                    <div class="flex items-center gap-2">
                      <div class="rating rating-md" id="rating-${testDef.slug}-${c.key}">
                        <input type="radio" name="${testDef.slug}-${c.key}" class="rating-hidden" value="0" ${!preScores[c.key] ? 'checked' : ''} />
                        ${[1,2,3,4,5].map(v => `
                          <input type="radio" name="${testDef.slug}-${c.key}" class="mask mask-star-2 bg-primary" value="${v}" ${preScores[c.key] === v ? 'checked' : ''} />
                        `).join('')}
                      </div>
                      <button class="btn btn-ghost btn-xs eval-reset" data-name="${testDef.slug}-${c.key}" title="Remettre à 0">&#x2715;</button>
                    </div>
                  </div>
                `).join('')}
              </div>
              <div class="divider my-2"></div>
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-sm font-bold">Total : </span>
                  <span class="text-lg font-bold text-primary eval-total" data-grid="${gridId}">0</span>
                  <span class="text-sm text-base-content/50">/${maxScore}</span>
                  <span class="badge badge-sm ml-2 eval-verdict" data-grid="${gridId}"></span>
                </div>
                <button class="btn btn-primary btn-sm eval-save" data-test-def-id="${testDef.id}" data-grid="${gridId}" data-max="${maxScore}" data-slug="${testDef.slug}">Enregistrer</button>
              </div>
            </div>
          </div>
        `;

        gridsContainer.insertAdjacentHTML('beforeend', gridHtml);
      }

      // Wire up event listeners for all grids
      gridsContainer.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener('change', () => {
          const gridId = input.closest('.eval-criteria')?.getAttribute('data-grid');
          if (gridId) updateEvalTotal(gridId);
        });
      });

      gridsContainer.querySelectorAll('.eval-reset').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = (btn as HTMLButtonElement).dataset.name!;
          const hidden = document.querySelector(`input[name="${name}"].rating-hidden`) as HTMLInputElement;
          if (hidden) hidden.checked = true;
          const gridId = btn.closest('.eval-criteria')?.getAttribute('data-grid');
          if (gridId) updateEvalTotal(gridId);
        });
      });

      gridsContainer.querySelectorAll('.eval-reset-all').forEach(btn => {
        btn.addEventListener('click', () => {
          const gridId = (btn as HTMLButtonElement).dataset.grid!;
          const grid = document.getElementById(gridId)!;
          grid.querySelectorAll('.rating-hidden').forEach(h => {
            (h as HTMLInputElement).checked = true;
          });
          updateEvalTotal(gridId);
        });
      });

      gridsContainer.querySelectorAll('.eval-save').forEach(btn => {
        btn.addEventListener('click', async () => {
          const gridId = (btn as HTMLButtonElement).dataset.grid!;
          const testDefId = (btn as HTMLButtonElement).dataset.testDefId!;
          const maxScore = parseInt((btn as HTMLButtonElement).dataset.max!);
          const slug = (btn as HTMLButtonElement).dataset.slug!;

          const grid = document.getElementById(gridId)!;
          const scores: Record<string, number> = {};

          grid.querySelectorAll('[data-criterion]').forEach(row => {
            const key = row.getAttribute('data-criterion')!;
            const checked = row.querySelector(`input[name="${slug}-${key}"]:checked`) as HTMLInputElement;
            scores[key] = checked ? parseInt(checked.value) : 0;
          });

          const total = Object.values(scores).reduce((a, b) => a + b, 0);
          const pct = Math.round((total / maxScore) * 100);

          const { data: { session: evalSession } } = await supabase.auth.getSession();
          if (!evalSession) return;

          const { error: evalError } = await supabase
            .from('evaluations')
            .upsert({
              application_id: appId,
              test_definition_id: testDefId,
              evaluator_id: evalSession.user.id,
              scores,
              total_score: total,
              max_score: maxScore,
            }, { onConflict: 'application_id,test_definition_id,evaluator_id' });

          if (evalError) {
            alert('Erreur: ' + evalError.message);
          } else {
            // Also save backward-compatible human_score for roleplay
            if (slug === 'roleplay') {
              await supabase.from('test_results').upsert({
                application_id: appId,
                test_type: 'human_score',
                score: pct,
                result_data: scores,
                completed_at: new Date().toISOString(),
              }, { onConflict: 'application_id,test_type' });
            }
            alert(`Score enregistré : ${total}/${maxScore} (${pct}%)`);
          }
        });
      });

      // Initialize totals
      evaluableTests.forEach(td => {
        updateEvalTotal(`eval-grid-${td.slug}`);
      });
    }

    function updateEvalTotal(gridId: string) {
      const grid = document.getElementById(gridId);
      if (!grid) return;

      let total = 0;
      grid.querySelectorAll('[data-criterion]').forEach(row => {
        const checked = row.querySelector('input[type="radio"]:checked') as HTMLInputElement;
        total += checked ? parseInt(checked.value) : 0;
      });

      const totalEl = grid.querySelector(`.eval-total[data-grid="${gridId}"]`);
      if (totalEl) totalEl.textContent = String(total);

      const maxStr = grid.querySelector('.eval-save')?.getAttribute('data-max') || '30';
      const maxScore = parseInt(maxStr);
      const pct = maxScore > 0 ? Math.round((total / maxScore) * 100) : 0;

      const verdict = grid.querySelector(`.eval-verdict[data-grid="${gridId}"]`);
      if (verdict) {
        if (pct >= 83) {
          verdict.textContent = 'Excellent';
          verdict.className = 'badge badge-sm badge-success ml-2 eval-verdict';
        } else if (pct >= 60) {
          verdict.textContent = 'Acceptable';
          verdict.className = 'badge badge-sm badge-info ml-2 eval-verdict';
        } else if (total > 0) {
          verdict.textContent = 'Insuffisant';
          verdict.className = 'badge badge-sm badge-error ml-2 eval-verdict';
        } else {
          verdict.textContent = '';
          verdict.className = 'badge badge-sm ml-2 eval-verdict';
        }
        (verdict as HTMLElement).setAttribute('data-grid', gridId);
      }
    }

    loadDetail();
  </script>
</AdminLayout>
