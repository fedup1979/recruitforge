---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="D√©tail candidat ‚Äî AMBITIA Admin">
  <!-- Loading -->
  <div id="loading" class="flex items-center justify-center py-16">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>

  <!-- Not found -->
  <div id="not-found" class="text-center py-16 hidden">
    <h2 class="text-xl font-semibold text-base-content/50 mb-2">Candidature introuvable</h2>
    <a href="/admin/candidates" class="btn btn-primary btn-sm mt-4">Retour √† la liste</a>
  </div>

  <!-- Detail content -->
  <div id="detail" class="hidden">
    <div class="flex items-center gap-2 mb-6">
      <a href="/admin/candidates" class="btn btn-ghost btn-sm">‚Üê Retour</a>
    </div>

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
      <div>
        <h1 class="text-2xl font-bold text-base-content" id="candidate-name">‚Äî</h1>
        <p class="text-base-content/60" id="candidate-email">‚Äî</p>
      </div>
      <div class="flex items-center gap-3">
        <select id="status-select" class="select select-bordered select-sm">
          <option value="pending">En attente</option>
          <option value="testing">Tests</option>
          <option value="review">Review</option>
          <option value="interview">Entretien</option>
          <option value="hired">Embauch√©</option>
          <option value="rejected">Refus√©</option>
          <option value="pool">Vivier</option>
        </select>
        <button id="save-status" class="btn btn-primary btn-sm">Sauvegarder</button>
      </div>
    </div>

    <!-- Info grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- Profile info -->
      <div class="card bg-base-200">
        <div class="card-body">
          <h2 class="card-title text-base">Profil</h2>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-base-content/60">T√©l√©phone</span><span id="info-phone">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Pays</span><span id="info-country">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">R√¥le</span><span id="info-role">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Inscription</span><span id="info-created">‚Äî</span></div>
          </div>
        </div>
      </div>

      <!-- Application info -->
      <div class="card bg-base-200">
        <div class="card-body">
          <h2 class="card-title text-base">Candidature</h2>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-base-content/60">Poste</span><span id="info-job">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Pays du poste</span><span id="info-job-country">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Date de candidature</span><span id="info-app-date">‚Äî</span></div>
            <div class="flex justify-between"><span class="text-base-content/60">Statut</span><span id="info-status" class="badge badge-sm">‚Äî</span></div>
          </div>
          <div class="mt-3" id="cv-container">
            <!-- CV link if available -->
          </div>
        </div>
      </div>
    </div>

    <!-- Knockout answers -->
    <div class="card bg-base-200 mb-6" id="knockout-section">
      <div class="card-body">
        <h2 class="card-title text-base">R√©ponses de pr√©s√©lection</h2>
        <div id="knockout-answers" class="space-y-2 text-sm">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Test results -->
    <div class="card bg-base-200 mb-6" id="tests-section">
      <div class="card-body">
        <h2 class="card-title text-base">R√©sultats des tests</h2>
        <div id="test-results" class="space-y-3">
          <!-- Populated by JS -->
        </div>
        <div id="no-tests" class="text-base-content/50 text-sm hidden">Aucun test compl√©t√©.</div>
      </div>
    </div>

    <!-- Human scoring -->
    <div class="card bg-base-200 mb-6" id="scoring-section">
      <div class="card-body">
        <h2 class="card-title text-base">Grille d'√©valuation Roleplay</h2>
        <p class="text-xs text-base-content/50 mb-3">Score chaque crit√®re de 1 (faible) √† 5 (excellent). Minimum pour avancer : 18/30.</p>
        <div class="space-y-3" id="scoring-grid">
          <div class="flex items-center justify-between gap-4" data-criterion="ouverture">
            <div class="min-w-[140px]"><span class="font-medium text-sm">Ouverture</span><p class="text-xs text-base-content/40">Naturelle, chaleureuse</p></div>
            <div class="rating rating-md" id="rating-ouverture">
              <input type="radio" name="ouverture" class="rating-hidden" value="0" checked />
              <input type="radio" name="ouverture" class="mask mask-star-2 bg-primary" value="1" />
              <input type="radio" name="ouverture" class="mask mask-star-2 bg-primary" value="2" />
              <input type="radio" name="ouverture" class="mask mask-star-2 bg-primary" value="3" />
              <input type="radio" name="ouverture" class="mask mask-star-2 bg-primary" value="4" />
              <input type="radio" name="ouverture" class="mask mask-star-2 bg-primary" value="5" />
            </div>
          </div>
          <div class="flex items-center justify-between gap-4" data-criterion="qualification">
            <div class="min-w-[140px]"><span class="font-medium text-sm">Qualification</span><p class="text-xs text-base-content/40">Questions pertinentes, √©coute</p></div>
            <div class="rating rating-md" id="rating-qualification">
              <input type="radio" name="qualification" class="rating-hidden" value="0" checked />
              <input type="radio" name="qualification" class="mask mask-star-2 bg-primary" value="1" />
              <input type="radio" name="qualification" class="mask mask-star-2 bg-primary" value="2" />
              <input type="radio" name="qualification" class="mask mask-star-2 bg-primary" value="3" />
              <input type="radio" name="qualification" class="mask mask-star-2 bg-primary" value="4" />
              <input type="radio" name="qualification" class="mask mask-star-2 bg-primary" value="5" />
            </div>
          </div>
          <div class="flex items-center justify-between gap-4" data-criterion="objections">
            <div class="min-w-[140px]"><span class="font-medium text-sm">Gestion objections</span><p class="text-xs text-base-content/40">R√©pond avec assurance, rebondit</p></div>
            <div class="rating rating-md" id="rating-objections">
              <input type="radio" name="objections" class="rating-hidden" value="0" checked />
              <input type="radio" name="objections" class="mask mask-star-2 bg-primary" value="1" />
              <input type="radio" name="objections" class="mask mask-star-2 bg-primary" value="2" />
              <input type="radio" name="objections" class="mask mask-star-2 bg-primary" value="3" />
              <input type="radio" name="objections" class="mask mask-star-2 bg-primary" value="4" />
              <input type="radio" name="objections" class="mask mask-star-2 bg-primary" value="5" />
            </div>
          </div>
          <div class="flex items-center justify-between gap-4" data-criterion="closing">
            <div class="min-w-[140px]"><span class="font-medium text-sm">Closing</span><p class="text-xs text-base-content/40">Demande claire, assume</p></div>
            <div class="rating rating-md" id="rating-closing">
              <input type="radio" name="closing" class="rating-hidden" value="0" checked />
              <input type="radio" name="closing" class="mask mask-star-2 bg-primary" value="1" />
              <input type="radio" name="closing" class="mask mask-star-2 bg-primary" value="2" />
              <input type="radio" name="closing" class="mask mask-star-2 bg-primary" value="3" />
              <input type="radio" name="closing" class="mask mask-star-2 bg-primary" value="4" />
              <input type="radio" name="closing" class="mask mask-star-2 bg-primary" value="5" />
            </div>
          </div>
          <div class="flex items-center justify-between gap-4" data-criterion="ton">
            <div class="min-w-[140px]"><span class="font-medium text-sm">Ton g√©n√©ral</span><p class="text-xs text-base-content/40">Chaleureux, souriant</p></div>
            <div class="rating rating-md" id="rating-ton">
              <input type="radio" name="ton" class="rating-hidden" value="0" checked />
              <input type="radio" name="ton" class="mask mask-star-2 bg-primary" value="1" />
              <input type="radio" name="ton" class="mask mask-star-2 bg-primary" value="2" />
              <input type="radio" name="ton" class="mask mask-star-2 bg-primary" value="3" />
              <input type="radio" name="ton" class="mask mask-star-2 bg-primary" value="4" />
              <input type="radio" name="ton" class="mask mask-star-2 bg-primary" value="5" />
            </div>
          </div>
          <div class="flex items-center justify-between gap-4" data-criterion="ecoute">
            <div class="min-w-[140px]"><span class="font-medium text-sm">√âcoute</span><p class="text-xs text-base-content/40">Reformule, adapte</p></div>
            <div class="rating rating-md" id="rating-ecoute">
              <input type="radio" name="ecoute" class="rating-hidden" value="0" checked />
              <input type="radio" name="ecoute" class="mask mask-star-2 bg-primary" value="1" />
              <input type="radio" name="ecoute" class="mask mask-star-2 bg-primary" value="2" />
              <input type="radio" name="ecoute" class="mask mask-star-2 bg-primary" value="3" />
              <input type="radio" name="ecoute" class="mask mask-star-2 bg-primary" value="4" />
              <input type="radio" name="ecoute" class="mask mask-star-2 bg-primary" value="5" />
            </div>
          </div>
        </div>
        <div class="divider my-2"></div>
        <div class="flex items-center justify-between">
          <div>
            <span class="text-sm font-bold">Total : </span>
            <span id="score-total" class="text-lg font-bold text-primary">0</span>
            <span class="text-sm text-base-content/50">/30</span>
            <span id="score-verdict" class="badge badge-sm ml-2"></span>
          </div>
          <button id="save-score" class="btn btn-primary btn-sm">Enregistrer le score</button>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="card bg-base-200 mb-6">
      <div class="card-body">
        <h2 class="card-title text-base">Notes internes</h2>
        <textarea id="notes-input" class="textarea textarea-bordered w-full" rows="4" placeholder="Ajouter des notes sur ce candidat‚Ä¶"></textarea>
        <div class="card-actions justify-end mt-2">
          <button id="save-notes" class="btn btn-sm btn-outline">Enregistrer les notes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const params = new URLSearchParams(window.location.search);
    const appId = params.get('id');

    const statusLabels: Record<string, { label: string; class: string }> = {
      pending: { label: 'En attente', class: 'badge-warning' },
      testing: { label: 'Tests', class: 'badge-info' },
      review: { label: 'Review', class: 'badge-secondary' },
      interview: { label: 'Entretien', class: 'badge-accent' },
      hired: { label: 'Embauch√©', class: 'badge-success' },
      rejected: { label: 'Refus√©', class: 'badge-error' },
      pool: { label: 'Vivier', class: 'badge-neutral' },
    };

    async function loadDetail() {
      if (!appId) {
        document.getElementById('loading')!.classList.add('hidden');
        document.getElementById('not-found')!.classList.remove('hidden');
        return;
      }

      const { data: app, error } = await supabase
        .from('applications')
        .select(`
          id, status, created_at, knockout_answers, admin_notes,
          profiles(id, full_name, email, phone, country, role, created_at),
          jobs(id, title, country, salary_label),
          test_results(test_type, score, result_data, completed_at)
        `)
        .eq('id', appId)
        .single();

      document.getElementById('loading')!.classList.add('hidden');

      if (error || !app) {
        document.getElementById('not-found')!.classList.remove('hidden');
        return;
      }

      document.getElementById('detail')!.classList.remove('hidden');

      const profile = app.profiles as any;
      const job = app.jobs as any;
      const status = statusLabels[app.status] || { label: app.status, class: 'badge-ghost' };

      // Header
      document.getElementById('candidate-name')!.textContent = profile?.full_name || 'Candidat';
      document.getElementById('candidate-email')!.textContent = profile?.email || '';
      (document.getElementById('status-select') as HTMLSelectElement).value = app.status;

      // Profile info
      document.getElementById('info-phone')!.textContent = profile?.phone || '‚Äî';
      document.getElementById('info-country')!.textContent = profile?.country || '‚Äî';
      document.getElementById('info-role')!.textContent = profile?.role || '‚Äî';
      document.getElementById('info-created')!.textContent = profile?.created_at
        ? new Date(profile.created_at).toLocaleDateString('fr-FR')
        : '‚Äî';

      // Application info
      document.getElementById('info-job')!.textContent = job?.title || '‚Äî';
      document.getElementById('info-job-country')!.textContent = job?.country || '‚Äî';
      document.getElementById('info-app-date')!.textContent = new Date(app.created_at).toLocaleDateString('fr-FR');
      const statusBadge = document.getElementById('info-status')!;
      statusBadge.textContent = status.label;
      statusBadge.className = `badge badge-sm ${status.class}`;

      // CV download
      const cvContainer = document.getElementById('cv-container')!;
      if (profile?.id) {
        const { data: files } = await supabase.storage
          .from('candidates')
          .list(`${profile.id}/cv`);

        if (files && files.length > 0) {
          const { data: urlData } = await supabase.storage
            .from('candidates')
            .createSignedUrl(`${profile.id}/cv/${files[0].name}`, 3600);

          if (urlData?.signedUrl) {
            cvContainer.innerHTML = `<a href="${urlData.signedUrl}" target="_blank" class="btn btn-outline btn-sm">üìÑ T√©l√©charger le CV</a>`;
          }
        }
      }

      // Knockout answers
      const knockoutDiv = document.getElementById('knockout-answers')!;
      if (app.knockout_answers && typeof app.knockout_answers === 'object') {
        const answers = app.knockout_answers as Record<string, any>;
        const questionLabels: Record<string, string> = {
          availability: 'Disponibilit√© imm√©diate',
          internet: 'Connexion internet stable',
          french: 'Niveau de fran√ßais',
          experience: 'Exp√©rience en appels',
        };
        knockoutDiv.innerHTML = Object.entries(answers).map(([key, val]) =>
          `<div class="flex justify-between"><span class="text-base-content/60">${questionLabels[key] || key}</span><span class="font-medium">${val}</span></div>`
        ).join('');
      } else {
        document.getElementById('knockout-section')!.classList.add('hidden');
      }

      // Test results
      const testResults = (app.test_results || []) as any[];
      const testDiv = document.getElementById('test-results')!;
      const noTests = document.getElementById('no-tests')!;

      if (testResults.length === 0) {
        noTests.classList.remove('hidden');
      } else {
        testDiv.innerHTML = testResults.map((t: any) => {
          const typeLabel = t.test_type === 'bigfive' ? 'Big Five (TIPI-10)' : t.test_type === 'quiz' ? 'Quiz ESSR' : t.test_type;
          const date = t.completed_at ? new Date(t.completed_at).toLocaleDateString('fr-FR') : '‚Äî';
          let details = '';

          if (t.test_type === 'bigfive' && t.result_data) {
            const traits = t.result_data as Record<string, number>;
            details = `<div class="grid grid-cols-5 gap-2 mt-2">${
              Object.entries(traits).map(([trait, score]) =>
                `<div class="text-center"><div class="text-xs text-base-content/50">${trait}</div><div class="font-bold text-sm">${score}</div></div>`
              ).join('')
            }</div>`;
          }

          return `
            <div class="bg-base-100 rounded-box p-3">
              <div class="flex items-center justify-between">
                <span class="font-medium text-sm">${typeLabel}</span>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-base-content/50">${date}</span>
                  ${t.score !== null ? `<span class="badge badge-sm badge-primary">${t.score}%</span>` : ''}
                </div>
              </div>
              ${details}
            </div>
          `;
        }).join('');
      }

      // Notes
      const notesInput = document.getElementById('notes-input') as HTMLTextAreaElement;
      notesInput.value = (app as any).admin_notes || '';

      // Save status handler
      document.getElementById('save-status')!.addEventListener('click', async () => {
        const newStatus = (document.getElementById('status-select') as HTMLSelectElement).value;
        const { error: updateError } = await supabase
          .from('applications')
          .update({ status: newStatus })
          .eq('id', appId);

        if (updateError) {
          alert('Erreur: ' + updateError.message);
        } else {
          const s = statusLabels[newStatus] || { label: newStatus, class: 'badge-ghost' };
          const badge = document.getElementById('info-status')!;
          badge.textContent = s.label;
          badge.className = `badge badge-sm ${s.class}`;
          alert('Statut mis √† jour.');
        }
      });

      // Save notes handler
      document.getElementById('save-notes')!.addEventListener('click', async () => {
        const notes = notesInput.value;
        const { error: notesError } = await supabase
          .from('applications')
          .update({ admin_notes: notes })
          .eq('id', appId);

        if (notesError) {
          alert('Erreur: ' + notesError.message);
        } else {
          alert('Notes enregistr√©es.');
        }
      });

      // Load existing human score
      const existingHumanScore = testResults.find((t: any) => t.test_type === 'human_score');
      if (existingHumanScore?.result_data) {
        const scores = existingHumanScore.result_data as Record<string, number>;
        const criteria = ['ouverture', 'qualification', 'objections', 'closing', 'ton', 'ecoute'];
        criteria.forEach(c => {
          if (scores[c]) {
            const radio = document.querySelector(`input[name="${c}"][value="${scores[c]}"]`) as HTMLInputElement;
            if (radio) radio.checked = true;
          }
        });
        updateScoreTotal();
      }
    }

    // Score calculation
    function getScoreValues(): Record<string, number> {
      const criteria = ['ouverture', 'qualification', 'objections', 'closing', 'ton', 'ecoute'];
      const scores: Record<string, number> = {};
      criteria.forEach(c => {
        const checked = document.querySelector(`input[name="${c}"]:checked`) as HTMLInputElement;
        scores[c] = checked ? parseInt(checked.value) : 0;
      });
      return scores;
    }

    function updateScoreTotal() {
      const scores = getScoreValues();
      const total = Object.values(scores).reduce((a, b) => a + b, 0);
      document.getElementById('score-total')!.textContent = String(total);
      const verdict = document.getElementById('score-verdict')!;
      if (total >= 25) {
        verdict.textContent = 'Excellent';
        verdict.className = 'badge badge-sm badge-success ml-2';
      } else if (total >= 18) {
        verdict.textContent = 'Acceptable';
        verdict.className = 'badge badge-sm badge-info ml-2';
      } else if (total > 0) {
        verdict.textContent = 'Insuffisant';
        verdict.className = 'badge badge-sm badge-error ml-2';
      } else {
        verdict.textContent = '';
        verdict.className = 'badge badge-sm ml-2';
      }
    }

    // Listen for rating changes
    document.querySelectorAll('#scoring-grid input[type="radio"]').forEach(input => {
      input.addEventListener('change', updateScoreTotal);
    });

    // Save score
    document.getElementById('save-score')!.addEventListener('click', async () => {
      const scores = getScoreValues();
      const total = Object.values(scores).reduce((a, b) => a + b, 0);
      const pct = Math.round((total / 30) * 100);

      const { error: scoreError } = await supabase
        .from('test_results')
        .upsert({
          application_id: appId,
          test_type: 'human_score',
          score: pct,
          result_data: scores,
          completed_at: new Date().toISOString(),
        }, { onConflict: 'application_id,test_type' });

      if (scoreError) {
        alert('Erreur: ' + scoreError.message);
      } else {
        alert(`Score enregistr√© : ${total}/30 (${pct}%)`);
      }
    });

    loadDetail();
  </script>
</AdminLayout>
