---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Quiz produit — AMBITIA" description="Testez vos connaissances sur le produit ou service que vous allez promouvoir.">
  <section class="py-12 px-4">
    <div class="max-w-2xl mx-auto">
      <!-- Loading -->
      <div id="loading" class="text-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>

      <!-- Quiz content -->
      <div id="quiz-content" class="hidden">
        <!-- Video placeholder -->
        <div class="mb-8">
          <h1 class="text-2xl font-bold text-base-content mb-4">Quiz de connaissances produit</h1>
          <div class="aspect-video rounded-xl bg-base-200 flex flex-col items-center justify-center text-center p-6 border border-base-300/30 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-3 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-sm text-base-content/50">Vidéo de présentation — bientôt disponible</p>
          </div>
          <p class="text-base-content/60 text-sm">Lisez attentivement les informations ci-dessous avant de répondre au quiz.</p>
        </div>

        <!-- Key info summary -->
        <div class="bg-base-200 rounded-xl p-5 mb-8 space-y-3">
          <h3 class="font-semibold text-base-content">Points clés à retenir :</h3>
          <ul class="space-y-2 text-sm text-base-content/80">
            <li>&#x2022; Vous allez promouvoir une <strong>formation professionnelle en ligne</strong></li>
            <li>&#x2022; La formation dure <strong>3 mois</strong> et se fait à distance</li>
            <li>&#x2022; Le paiement est possible en <strong>plusieurs fois</strong></li>
            <li>&#x2022; L'organisme de formation est <strong>certifié et reconnu</strong></li>
            <li>&#x2022; Plus de 1 000 avis positifs en ligne (4.9/5 étoiles)</li>
            <li>&#x2022; Taux de réussite : <strong>95%</strong></li>
          </ul>
        </div>

        <!-- Progress -->
        <div class="flex items-center justify-between mb-4">
          <span class="text-sm text-base-content/50">Question <span id="current-q">1</span>/8</span>
          <span class="text-sm font-medium text-primary" id="progress-pct">0%</span>
        </div>
        <progress id="quiz-progress" class="progress progress-primary w-full mb-6" value="0" max="100"></progress>

        <!-- Question -->
        <div id="question-container">
          <p id="question-text" class="text-lg font-medium text-base-content mb-4"></p>
          <div id="options-container" class="space-y-2"></div>
          <button id="next-btn" class="btn btn-primary w-full mt-6" disabled>Suivant</button>
        </div>

        <!-- Results -->
        <div id="results" class="text-center py-8 hidden">
          <div class="text-5xl mb-4" id="result-emoji"></div>
          <h2 class="text-2xl font-bold text-base-content mb-2">Quiz terminé !</h2>
          <p class="text-lg text-base-content/70 mb-2">Votre score : <span id="score-display" class="font-bold text-primary"></span></p>
          <a href="/dashboard" class="btn btn-primary mt-4">Retour au tableau de bord</a>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  const quizQuestions = [
    {
      question: 'Quel est le principal objectif d\'un setter ?',
      options: ['Vendre directement le produit', 'Booker un rendez-vous avec un conseiller', 'Envoyer des emails promotionnels', 'Créer du contenu marketing'],
      correct: 1,
    },
    {
      question: 'Combien de leads un setter traite-t-il en moyenne par jour ?',
      options: ['10-20', '30-50', '50-80', '100-200'],
      correct: 1,
    },
    {
      question: 'Quelle est la durée typique de la formation proposée ?',
      options: ['1 mois', '3 mois', '6 mois', '12 mois'],
      correct: 1,
    },
    {
      question: 'Quel est le KPI principal d\'un setter ?',
      options: ['Nombre d\'emails envoyés', 'Taux de rendez-vous bookés', 'Nombre de ventes conclues', 'Durée moyenne d\'appel'],
      correct: 1,
    },
    {
      question: 'Quel est le taux de réussite annoncé de la formation ?',
      options: ['75%', '85%', '95%', '100%'],
      correct: 2,
    },
    {
      question: 'Quelle est la meilleure réaction face à l\'objection « Je dois réfléchir » ?',
      options: ['Raccrocher et rappeler plus tard', 'Demander ce qui fait hésiter, puis rassurer', 'Insister lourdement sur l\'urgence', 'Proposer une réduction de prix'],
      correct: 1,
    },
    {
      question: 'Quelles modalités de paiement proposer à un prospect ?',
      options: ['Paiement unique obligatoire', 'Paiement en plusieurs fois', 'Gratuit, financé par l\'État', 'Paiement à crédit bancaire'],
      correct: 1,
    },
    {
      question: 'Que signifie un bon taux de contact ?',
      options: ['Plus de 20% des appels aboutissent', 'Plus de 50% des appels aboutissent', 'Plus de 80% des appels aboutissent', '100% des appels aboutissent'],
      correct: 1,
    },
  ];

  const loadingDiv = document.getElementById('loading') as HTMLDivElement;
  const quizContent = document.getElementById('quiz-content') as HTMLDivElement;
  const questionText = document.getElementById('question-text') as HTMLParagraphElement;
  const optionsContainer = document.getElementById('options-container') as HTMLDivElement;
  const currentQSpan = document.getElementById('current-q') as HTMLSpanElement;
  const progressPct = document.getElementById('progress-pct') as HTMLSpanElement;
  const quizProgress = document.getElementById('quiz-progress') as HTMLProgressElement;
  const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
  const resultsDiv = document.getElementById('results') as HTMLDivElement;
  const questionContainer = document.getElementById('question-container') as HTMLDivElement;
  const scoreDisplay = document.getElementById('score-display') as HTMLSpanElement;
  const resultEmoji = document.getElementById('result-emoji') as HTMLDivElement;

  let currentQuestion = 0;
  const answers: Record<number, number> = {};
  let applicationId: string | null = null;

  const params = new URLSearchParams(window.location.search);
  applicationId = params.get('app');

  function showQuestion() {
    if (currentQuestion >= quizQuestions.length) {
      submitQuiz();
      return;
    }

    const q = quizQuestions[currentQuestion];
    questionText.textContent = q.question;
    currentQSpan.textContent = String(currentQuestion + 1);

    const pct = Math.round((currentQuestion / quizQuestions.length) * 100);
    progressPct.textContent = `${pct}%`;
    quizProgress.value = pct;

    optionsContainer.innerHTML = q.options.map((opt, i) => `
      <label class="flex items-center gap-3 p-3 rounded-lg bg-base-200 cursor-pointer hover:bg-base-300 transition-colors">
        <input type="radio" name="quiz-answer" value="${i}" class="radio radio-primary" />
        <span>${opt}</span>
      </label>
    `).join('');

    nextBtn.disabled = true;
    optionsContainer.querySelectorAll<HTMLInputElement>('input[name="quiz-answer"]').forEach(radio => {
      radio.addEventListener('change', () => { nextBtn.disabled = false; });
    });
  }

  nextBtn?.addEventListener('click', () => {
    const selected = document.querySelector<HTMLInputElement>('input[name="quiz-answer"]:checked');
    if (!selected) return;
    answers[currentQuestion] = parseInt(selected.value);
    currentQuestion++;
    showQuestion();
  });

  async function submitQuiz() {
    questionContainer.classList.add('hidden');
    quizProgress.value = 100;
    progressPct.textContent = '100%';

    let correct = 0;
    quizQuestions.forEach((q, i) => {
      if (answers[i] === q.correct) correct++;
    });

    const score = Math.round((correct / quizQuestions.length) * 100);
    scoreDisplay.textContent = `${correct}/${quizQuestions.length} (${score}%)`;
    resultEmoji.textContent = score >= 75 ? '\u2705' : score >= 50 ? '\u26A0\uFE0F' : '\u274C';

    if (applicationId) {
      await supabase.from('test_results').insert({
        application_id: applicationId,
        test_type: 'quiz',
        answers,
        score,
        completed_at: new Date().toISOString(),
      });
    }

    resultsDiv.classList.remove('hidden');
  }

  async function init() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) { window.location.href = '/login'; return; }
    if (!applicationId) { window.location.href = '/dashboard'; return; }

    loadingDiv.classList.add('hidden');
    quizContent.classList.remove('hidden');
    showQuestion();
  }

  init();
</script>
