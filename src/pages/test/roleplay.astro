---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Roleplay vocal — AMBITIA" description="Test de roleplay avec IA vocale.">
  <section class="py-12 px-4">
    <div class="max-w-2xl mx-auto">
      <!-- Loading -->
      <div id="loading" class="text-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="text-base-content/60 mt-4">Chargement...</p>
      </div>

      <!-- Consent modal -->
      <dialog id="consent-modal" class="modal">
        <div class="modal-box">
          <h3 class="font-bold text-lg">Consentement — Enregistrement vocal</h3>
          <div class="py-4 space-y-3 text-sm">
            <p>Ce test implique un <strong>enregistrement vocal</strong> de votre appel avec notre IA.</p>
            <p>Les données collectées :</p>
            <ul class="list-disc list-inside space-y-1">
              <li>Enregistrement audio de l'appel</li>
              <li>Transcription automatique de la conversation</li>
            </ul>
            <p>Ces données seront utilisées <strong>uniquement</strong> pour évaluer votre candidature et seront conservées conformément à notre politique de confidentialité (3 ans max).</p>
            <p>Vous pouvez demander la suppression de vos données à tout moment en contactant <strong>privacy@ambitia.io</strong>.</p>
          </div>
          <div class="modal-action">
            <button id="consent-decline" class="btn">Refuser</button>
            <button id="consent-accept" class="btn btn-primary">J'accepte</button>
          </div>
        </div>
      </dialog>

      <!-- Main content -->
      <div id="roleplay-content" class="hidden">
        <!-- Instructions -->
        <div id="instructions-section">
          <h1 class="text-2xl font-bold text-base-content mb-4">Test de Roleplay Vocal</h1>
          <div class="alert alert-info mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Vous allez simuler un appel téléphonique avec un prospect. Votre objectif : booker un rendez-vous avec notre conseiller(ère).</span>
          </div>

          <div class="card bg-base-200 mb-6">
            <div class="card-body">
              <h2 class="card-title text-base">Comment ça marche</h2>
              <ol class="list-decimal list-inside space-y-2 text-sm">
                <li>Vous allez parler avec une IA qui joue le rôle d'un prospect</li>
                <li>Présentez-vous et qualifiez le prospect</li>
                <li>Gérez les objections si nécessaire</li>
                <li>Essayez de booker un rendez-vous avec notre conseiller(ère)</li>
              </ol>
            </div>
          </div>

          <div class="card bg-base-200 mb-6">
            <div class="card-body">
              <h2 class="card-title text-base" id="scenario-title">Scénario</h2>
              <p class="text-sm" id="scenario-description"></p>
            </div>
          </div>

          <div class="text-center">
            <button id="btn-start" class="btn btn-primary btn-lg">Je suis prêt</button>
          </div>
        </div>

        <!-- In-call UI -->
        <div id="call-section" class="hidden">
          <div class="card bg-base-200">
            <div class="card-body items-center text-center">
              <!-- Call status indicator -->
              <div id="call-avatar" class="w-24 h-24 rounded-full bg-primary/20 flex items-center justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
              </div>

              <p class="font-semibold text-lg text-base-content" id="call-status">Connexion en cours...</p>
              <p class="text-3xl font-mono text-primary my-4" id="call-timer">00:00</p>

              <!-- Speaking indicator -->
              <div id="speaking-indicator" class="hidden flex items-center gap-2 text-sm text-success mb-4">
                <span class="w-2 h-2 bg-success rounded-full animate-pulse"></span>
                <span>L'IA parle...</span>
              </div>

              <!-- Microphone permission hint -->
              <p id="mic-hint" class="text-xs text-base-content/40 mb-4">Autorisez l'accès au microphone quand demandé.</p>

              <button id="btn-end-call" class="btn btn-error gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.516l2.257-1.13a1 1 0 00.502-1.21L8.228 3.684A1 1 0 007.28 3H5z" />
                </svg>
                Raccrocher
              </button>
            </div>
          </div>
        </div>

        <!-- Error state -->
        <div id="error-section" class="hidden">
          <div class="alert alert-error mb-4">
            <span id="error-text">Une erreur est survenue.</span>
          </div>
          <div class="flex gap-2 justify-center">
            <button id="btn-retry" class="btn btn-primary btn-sm">Réessayer</button>
            <a href="/dashboard" class="btn btn-ghost btn-sm">Retour au tableau de bord</a>
          </div>
        </div>

        <!-- Completed -->
        <div id="completed-section" class="hidden text-center py-8">
          <div class="w-20 h-20 rounded-full bg-success/20 flex items-center justify-center mx-auto mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-base-content mb-2">Roleplay terminé !</h2>
          <p class="text-base-content/60 mb-2">Durée de l'appel : <span id="final-duration" class="font-mono font-bold">00:00</span></p>
          <p class="text-base-content/60 mb-6">Votre enregistrement a été sauvegardé. Un recruteur écoutera votre appel et évaluera votre performance.</p>
          <a href="/dashboard" class="btn btn-primary">Retour au tableau de bord</a>
        </div>
      </div>
    </div>
  </section>

  <script>
    import { createClient } from '@supabase/supabase-js';
    import Vapi from '@vapi-ai/web';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const vapiPublicKey = import.meta.env.PUBLIC_VAPI_PUBLIC_KEY;

    const params = new URLSearchParams(window.location.search);
    const applicationId = params.get('app');
    const scenarioType = params.get('scenario') || 'easy';

    let callStartTime: number | null = null;
    let timerInterval: number | null = null;
    let vapiInstance: Vapi | null = null;

    const scenarioInfo: Record<string, { title: string; description: string }> = {
      easy: {
        title: 'Scénario 1 : Sophie — Prospect motivée',
        description: 'Sophie, 32 ans, vendeuse. Elle a vu votre publicité et est très intéressée par la formation proposée. Elle est disponible et enthousiaste.',
      },
      medium: {
        title: 'Scénario 2 : Marie — Prospect hésitante',
        description: 'Marie, 38 ans, secrétaire. Elle a cliqué sur votre publicité par curiosité pour une formation professionnelle en ligne, mais elle hésite. Elle va vous poser des objections : prix, besoin de réfléchir, demande d\'infos par email.',
      },
    };

    // System prompts (server-side equivalent — the prospect behavior)
    const scenarioPrompts: Record<string, { systemPrompt: string; firstName: string; firstMessage: string }> = {
      easy: {
        firstName: 'Sophie',
        firstMessage: 'Allô ?',
        systemPrompt: `Tu es Sophie, 32 ans, vendeuse dans un magasin de vêtements à Paris. Tu as vu une publicité Facebook pour une formation professionnelle en ligne et tu as demandé des informations.

Tu es MOTIVÉE et INTÉRESSÉE. Tu veux changer de carrière.

Ton comportement :
- Tu réponds aux questions avec enthousiasme
- Tu poses des questions sur la formation (durée, prix, débouchés)
- Tu es disponible pour un rendez-vous
- Tu dis "oui" facilement quand on te propose un rendez-vous avec un conseiller

Si le setter te propose un rendez-vous, accepte après 1-2 questions.

IMPORTANT : Tu parles UNIQUEMENT en français. Tu es polie et chaleureuse. Garde tes réponses courtes (1-3 phrases).`,
      },
      medium: {
        firstName: 'Marie',
        firstMessage: 'Oui allô ?',
        systemPrompt: `Tu es Marie, 38 ans, secrétaire dans un cabinet d'avocats. Tu as cliqué sur une pub Facebook par curiosité pour une formation professionnelle en ligne, mais tu n'es PAS CONVAINCUE.

Tu es HÉSITANTE et SCEPTIQUE.

Ton comportement :
- Tu utilises ces objections (dans cet ordre, une par échange) :
  1. "Je ne sais pas, je réfléchis encore..."
  2. "C'est combien ? Ça doit être cher non ?"
  3. "Vous pouvez m'envoyer les infos par email plutôt ?"
  4. Si le setter gère bien les objections, accepte finalement le RDV
- Tu ne dis jamais "oui" tout de suite
- Tu es polie mais pas enthousiaste
- Tu poses des questions sur le prix et les modalités

Si le setter gère BIEN tes objections (réponses pertinentes, empathique), accepte le RDV.
Si le setter est MAUVAIS (robotique, agressif, ne répond pas), refuse et dis que tu rappelleras.

IMPORTANT : Tu parles UNIQUEMENT en français. Garde tes réponses courtes (1-3 phrases).`,
      },
    };

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = '/login'; return; }

      if (!applicationId) {
        window.location.href = '/dashboard';
        return;
      }

      document.getElementById('loading')!.classList.add('hidden');

      // Check consent
      const { data: existingConsent } = await supabase
        .from('consents')
        .select('id')
        .eq('user_id', session.user.id)
        .eq('consent_type', 'voice_recording')
        .single();

      if (!existingConsent) {
        const modal = document.getElementById('consent-modal') as HTMLDialogElement;
        modal.showModal();

        document.getElementById('consent-decline')!.addEventListener('click', () => {
          window.location.href = '/tests?app=' + applicationId;
        });

        document.getElementById('consent-accept')!.addEventListener('click', async () => {
          await supabase.from('consents').insert({
            user_id: session.user.id,
            consent_type: 'voice_recording',
            consent_text: 'Accepte l\'enregistrement vocal et la transcription pour le test de roleplay.',
          });
          modal.close();
          showContent();
        });
      } else {
        showContent();
      }
    }

    function showContent() {
      document.getElementById('roleplay-content')!.classList.remove('hidden');

      const info = scenarioInfo[scenarioType] || scenarioInfo.easy;
      document.getElementById('scenario-title')!.textContent = info.title;
      document.getElementById('scenario-description')!.textContent = info.description;
    }

    function showError(msg: string) {
      document.getElementById('instructions-section')!.classList.add('hidden');
      document.getElementById('call-section')!.classList.add('hidden');
      document.getElementById('error-text')!.textContent = msg;
      document.getElementById('error-section')!.classList.remove('hidden');
    }

    function formatTimer(seconds: number): string {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    // Start call
    document.getElementById('btn-start')!.addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      document.getElementById('instructions-section')!.classList.add('hidden');
      document.getElementById('call-section')!.classList.remove('hidden');

      try {
        // Initialize Vapi Web SDK
        vapiInstance = new Vapi(vapiPublicKey);

        const scenario = scenarioPrompts[scenarioType] || scenarioPrompts.easy;

        // Event handlers
        vapiInstance.on('call-start', () => {
          document.getElementById('call-status')!.textContent = `En appel avec ${scenario.firstName}`;
          document.getElementById('mic-hint')!.classList.add('hidden');
          callStartTime = Date.now();
          timerInterval = window.setInterval(() => {
            const elapsed = Math.floor((Date.now() - callStartTime!) / 1000);
            document.getElementById('call-timer')!.textContent = formatTimer(elapsed);
          }, 1000);
        });

        vapiInstance.on('call-end', () => {
          if (timerInterval) clearInterval(timerInterval);
          const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
          document.getElementById('final-duration')!.textContent = formatTimer(duration);
          saveResults(duration);
          document.getElementById('call-section')!.classList.add('hidden');
          document.getElementById('completed-section')!.classList.remove('hidden');
        });

        vapiInstance.on('speech-start', () => {
          document.getElementById('speaking-indicator')!.classList.remove('hidden');
          document.getElementById('call-avatar')!.classList.add('ring', 'ring-success', 'ring-offset-2');
        });

        vapiInstance.on('speech-end', () => {
          document.getElementById('speaking-indicator')!.classList.add('hidden');
          document.getElementById('call-avatar')!.classList.remove('ring', 'ring-success', 'ring-offset-2');
        });

        vapiInstance.on('error', (error: any) => {
          if (timerInterval) clearInterval(timerInterval);

          // Deep-extract the error message from any Vapi format
          let msg = 'Erreur inconnue';
          try {
            if (typeof error === 'string') {
              msg = error;
            } else if (error) {
              // Try all known paths
              msg = error?.error?.message
                || error?.error?.msg
                || error?.errorMessage
                || error?.message
                || error?.msg
                || error?.statusText
                || '';
              // If still empty, dump all keys and values
              if (!msg) {
                const keys = Object.keys(error);
                const parts: string[] = [];
                for (const k of keys) {
                  const v = error[k];
                  if (typeof v === 'string') parts.push(`${k}: ${v}`);
                  else if (typeof v === 'object' && v !== null) {
                    try { parts.push(`${k}: ${JSON.stringify(v)}`); } catch { parts.push(`${k}: [object]`); }
                  } else {
                    parts.push(`${k}: ${String(v)}`);
                  }
                }
                msg = parts.join(' | ') || 'Erreur Vapi (aucun détail)';
              }
            }
          } catch {
            msg = 'Erreur Vapi non sérialisable';
          }

          showError(msg);
        });

        // Start the call with inline assistant config
        await vapiInstance.start({
          model: {
            provider: 'openai',
            model: 'gpt-4o',
            messages: [
              {
                role: 'system',
                content: scenario.systemPrompt,
              },
            ],
          },
          voice: {
            provider: '11labs',
            voiceId: 'EXAVITQu4vr4xnSDxMaL',
          },
          firstMessage: scenario.firstMessage,
          transcriber: {
            provider: 'deepgram',
            language: 'fr',
          },
        } as any);

      } catch (err: any) {
        console.error('Start call error (full):', err);
        const msg = err?.error?.message || err?.message || JSON.stringify(err);
        showError(msg);
      }
    });

    // End call manually
    document.getElementById('btn-end-call')!.addEventListener('click', () => {
      if (vapiInstance) {
        vapiInstance.stop();
      }
    });

    // Retry after error
    document.getElementById('btn-retry')!.addEventListener('click', () => {
      document.getElementById('error-section')!.classList.add('hidden');
      document.getElementById('instructions-section')!.classList.remove('hidden');
    });

    // Save results to Supabase
    async function saveResults(durationSeconds: number) {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !applicationId) return;

      await supabase.from('test_results').upsert({
        application_id: applicationId,
        test_type: `roleplay_${scenarioType}`,
        score: null,
        result_data: {
          scenario: scenarioType,
          scenario_name: scenarioInfo[scenarioType]?.title || scenarioType,
          duration_seconds: durationSeconds,
        },
        completed_at: new Date().toISOString(),
      }, { onConflict: 'application_id,test_type' });
    }

    init();
  </script>
</BaseLayout>
