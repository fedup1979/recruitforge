---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Roleplay vocal — AMBITIA" description="Test de roleplay avec IA vocale.">
  <section class="py-12 px-4">
    <div class="max-w-2xl mx-auto">
      <!-- Loading -->
      <div id="loading" class="text-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="text-base-content/60 mt-4">Chargement...</p>
      </div>

      <!-- Consent modal -->
      <dialog id="consent-modal" class="modal">
        <div class="modal-box">
          <h3 class="font-bold text-lg">Consentement — Enregistrement vocal</h3>
          <div class="py-4 space-y-3 text-sm">
            <p>Ce test implique un <strong>enregistrement vocal</strong> de votre appel avec notre IA.</p>
            <p>Les données collectées :</p>
            <ul class="list-disc list-inside space-y-1">
              <li>Enregistrement audio de l'appel</li>
              <li>Transcription automatique de la conversation</li>
            </ul>
            <p>Ces données seront utilisées <strong>uniquement</strong> pour évaluer votre candidature et seront conservées conformément à notre politique de confidentialité (3 ans max).</p>
            <p>Vous pouvez demander la suppression de vos données à tout moment en contactant <strong>privacy@ambitia.io</strong>.</p>
          </div>
          <div class="modal-action">
            <button id="consent-decline" class="btn">Refuser</button>
            <button id="consent-accept" class="btn btn-primary">J'accepte</button>
          </div>
        </div>
      </dialog>

      <!-- Main content -->
      <div id="roleplay-content" class="hidden">
        <!-- Instructions -->
        <div id="instructions-section">
          <h1 class="text-2xl font-bold text-base-content mb-4">Test de Roleplay Vocal</h1>
          <div class="alert alert-info mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Vous allez simuler un appel téléphonique avec un prospect. Votre objectif : booker un rendez-vous avec Yasmine.</span>
          </div>

          <div class="card bg-base-200 mb-6">
            <div class="card-body">
              <h2 class="card-title text-base">Comment ça marche</h2>
              <ol class="list-decimal list-inside space-y-2 text-sm">
                <li>Vous allez parler avec une IA qui joue le rôle d'un prospect</li>
                <li>Présentez-vous et qualifiez le prospect</li>
                <li>Gérez les objections si nécessaire</li>
                <li>Essayez de booker un rendez-vous avec Yasmine</li>
              </ol>
            </div>
          </div>

          <div class="card bg-base-200 mb-6">
            <div class="card-body">
              <h2 class="card-title text-base" id="scenario-title">Scénario</h2>
              <p class="text-sm" id="scenario-description"></p>
            </div>
          </div>

          <div class="text-center">
            <button id="btn-start" class="btn btn-primary btn-lg">Je suis prêt</button>
          </div>
        </div>

        <!-- In-call UI -->
        <div id="call-section" class="hidden text-center">
          <h1 class="text-2xl font-bold text-base-content mb-8">Appel en cours</h1>

          <div class="flex flex-col items-center gap-6">
            <div class="w-24 h-24 rounded-full bg-primary/20 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
            </div>

            <div>
              <p class="text-lg font-semibold text-base-content" id="call-status">Connexion en cours...</p>
              <p class="text-2xl font-mono text-primary mt-2" id="call-timer">00:00</p>
            </div>

            <button id="btn-end-call" class="btn btn-error btn-lg mt-4">
              Raccrocher
            </button>
          </div>
        </div>

        <!-- Completed -->
        <div id="completed-section" class="hidden text-center py-8">
          <div class="w-20 h-20 rounded-full bg-success/20 flex items-center justify-center mx-auto mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-base-content mb-2">Roleplay terminé !</h2>
          <p class="text-base-content/60 mb-6">Votre enregistrement a été sauvegardé. Un recruteur écoutera votre appel et évaluera votre performance.</p>
          <a href="/dashboard" class="btn btn-primary">Retour au tableau de bord</a>
        </div>
      </div>
    </div>
  </section>

  <script>
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const params = new URLSearchParams(window.location.search);
    const applicationId = params.get('app');
    const scenarioType = params.get('scenario') || 'easy';

    let callStartTime: number | null = null;
    let timerInterval: number | null = null;

    const scenarioInfo: Record<string, { title: string; description: string }> = {
      easy: {
        title: 'Scénario 1 : Sophie — Prospect motivée',
        description: 'Sophie, 32 ans, vendeuse. Elle a vu votre publicité et est très intéressée par la Formation Secrétaire Médicale. Elle est disponible et enthousiaste.',
      },
      medium: {
        title: 'Scénario 2 : Marie — Prospect hésitante',
        description: 'Marie, 38 ans, secrétaire. Elle a cliqué sur votre publicité par curiosité mais hésite. Elle va vous poser des objections : prix, besoin de réfléchir, demande d\'infos par email.',
      },
    };

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = '/login'; return; }

      if (!applicationId) {
        window.location.href = '/dashboard';
        return;
      }

      document.getElementById('loading')!.classList.add('hidden');

      // Check consent
      const { data: existingConsent } = await supabase
        .from('consents')
        .select('id')
        .eq('user_id', session.user.id)
        .eq('consent_type', 'voice_recording')
        .single();

      if (!existingConsent) {
        const modal = document.getElementById('consent-modal') as HTMLDialogElement;
        modal.showModal();

        document.getElementById('consent-decline')!.addEventListener('click', () => {
          window.location.href = '/tests?app=' + applicationId;
        });

        document.getElementById('consent-accept')!.addEventListener('click', async () => {
          await supabase.from('consents').insert({
            user_id: session.user.id,
            consent_type: 'voice_recording',
            consent_text: 'Accepte l\'enregistrement vocal et la transcription pour le test de roleplay.',
          });
          modal.close();
          showContent();
        });
      } else {
        showContent();
      }
    }

    function showContent() {
      document.getElementById('roleplay-content')!.classList.remove('hidden');

      const info = scenarioInfo[scenarioType] || scenarioInfo.easy;
      document.getElementById('scenario-title')!.textContent = info.title;
      document.getElementById('scenario-description')!.textContent = info.description;
    }

    // Start call
    document.getElementById('btn-start')!.addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      document.getElementById('instructions-section')!.classList.add('hidden');
      document.getElementById('call-section')!.classList.remove('hidden');

      try {
        const response = await fetch(
          `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/create-vapi-call`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              applicationId,
              scenario: scenarioType,
            }),
          }
        );

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to create call');
        }

        const data = await response.json();

        document.getElementById('call-status')!.textContent = 'Appel en cours';

        // Start timer
        callStartTime = Date.now();
        timerInterval = window.setInterval(() => {
          const elapsed = Math.floor((Date.now() - callStartTime!) / 1000);
          const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
          const secs = String(elapsed % 60).padStart(2, '0');
          document.getElementById('call-timer')!.textContent = `${mins}:${secs}`;
        }, 1000);

        // If Vapi returns a web call URL, we could embed it
        // For now, the call is handled by Vapi's web interface
        if (data.webCallUrl) {
          // Open Vapi web call in current context
          window.open(data.webCallUrl, '_blank');
        }

      } catch (err: any) {
        document.getElementById('call-status')!.textContent = 'Erreur de connexion';
        alert('Erreur : ' + (err.message || 'Impossible de lancer l\'appel'));
      }
    });

    // End call and save results
    document.getElementById('btn-end-call')!.addEventListener('click', async () => {
      if (timerInterval) clearInterval(timerInterval);

      const callDuration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;

      document.getElementById('call-section')!.classList.add('hidden');

      // Save roleplay result to test_results
      const { data: { session } } = await supabase.auth.getSession();
      if (session && applicationId) {
        await supabase.from('test_results').insert({
          application_id: applicationId,
          test_type: 'roleplay',
          score: null,
          answers: {
            scenario: scenarioType,
            duration_seconds: callDuration,
          },
          completed_at: new Date().toISOString(),
        });
      }

      document.getElementById('completed-section')!.classList.remove('hidden');
    });

    init();
  </script>
</BaseLayout>
